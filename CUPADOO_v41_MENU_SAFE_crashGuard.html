<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1" />
<title>CUPADOO! ‚Äî Multiplayer (Firebase RTDB)</title>
<style>
:root { --bg:#0f172a; --panel:#0b1220; --card:#111827; --text:#e5e7eb; --muted:#94a3b8; --accent:#22c55e; --danger:#ef4444; --warn:#f59e0b; --table:#1e3a8a; --table2:#2563eb; }
*{ box-sizing:border-box; } body{ margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; }
.wrap{ max-width:980px; margin:0 auto; padding:16px; } .topbar{ position:relative; display:flex; align-items:flex-start; justify-content:space-between; gap:10px; margin-bottom:10px; }
.title{ display:flex; flex-direction:column; line-height:1; }
.brand{ font-weight:900; font-size:22px; letter-spacing:0.5px; font-family: 'Fredoka','Nunito','Poppins','system-ui',-apple-system,Segoe UI,Roboto,Helvetica,Arial; }
.brand .r{ color:#ff3b30; } .brand .y{ color:#ffd60a; } .brand .o{ color:#ff8c00; }
.slogan{ margin-top:4px; font-size:12px; color:var(--muted); font-weight:700; font-style:italic; }
.menu-btn{ padding:10px 12px; border-radius:12px; background:#0b1220; border:1px solid #1f2937; color:var(--text); font-weight:700; align-self:flex-start; }
.card{ background:var(--card); border-radius:18px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.35); }
h1{ margin:0 0 8px; font-size:24px; } h2{ margin:14px 0 8px; } .muted{ color:var(--muted); }
.row{ display:flex; gap:10px; } .row>*{ flex:1; }
button{ width:100%; padding:14px; border:none; border-radius:14px; font-weight:700; font-size:16px; background:linear-gradient(180deg,#22c55e,#16a34a); color:#05170c; cursor:pointer; }
button.secondary{ background:#1f2937; color:var(--text); }
button.warn{ background:linear-gradient(180deg,var(--warn),#eab308); color:#111; }
button.danger{ background:linear-gradient(180deg,var(--danger),#b91c1c); color:#fff; }
button.link{ background:#0b1220; color:var(--text); border:1px solid #1f2937; }
button[disabled]{ opacity:.45; cursor:not-allowed; }
input[type=number],input[type=text],select{ width:100%; padding:12px; border-radius:12px; border:1px solid #1f2937; background:var(--panel); color:var(--text); font-size:16px; }
.pill{ display:inline-block; padding:6px 10px; border-radius:999px; background:var(--panel); color:var(--muted); font-size:12px; }
.players{ display:grid; gap:10px; } .player{ display:flex; align-items:center; justify-content:space-between; background:#101523; border:1px solid #1f2937; padding:10px 12px; border-radius:14px; }
.player.you{ outline:2px solid var(--accent); } .turn{ border:1px dashed var(--accent); }
.player-left{ display:flex; align-items:center; gap:10px; } .player-right{ display:flex; align-items:center; gap:10px; }
.tag{ font-size:12px; color:var(--muted); }
.skull{ font-size:14px; filter:drop-shadow(0 1px 1px rgba(0,0,0,.4)); }
.dice{ display:flex; gap:8px; flex-wrap:wrap; justify-content:center; }
.die{ width:44px; height:44px; border-radius:12px; background:var(--panel); display:grid; place-items:center; font-weight:800; font-size:20px; border:1px solid #1f2937; }
.die.small{ width:22px; height:22px; font-size:13px; border-radius:6px; }
.die.reveal{ width:36px; height:36px; font-size:18px; transition:transform .35s ease, opacity .35s ease; }
.match{ box-shadow:0 0 0 2px var(--accent) inset, 0 0 10px rgba(34,197,94,.5); }
.fade-out .die.reveal{ transform:translateY(8px) scale(.9); opacity:0; }
.dudo-badge{ font-size:11px; padding:3px 7px; border-radius:999px; background:var(--danger); color:#fff; }
.hidden{ display:none !important; } .center{ text-align:center; } .big{ font-size:28px; font-weight:800; letter-spacing:1px; }
.toast{ position:fixed; bottom:16px; left:50%; transform:translateX(-50%); background:var(--panel); padding:12px 16px; border-radius:14px; border:1px solid #1f2937; z-index:999; }
.footer{ position:sticky; bottom:0; left:0; right:0; background:linear-gradient(180deg,transparent,rgba(0,0,0,.35)); padding-top:8px; }
.table-wrap{ display:grid; place-items:center; margin:12px 0 8px; }
.table{ width:100%; max-width:720px; aspect-ratio:1/1; border-radius:9999px; background:radial-gradient(75% 75% at 50% 30%, var(--table2), var(--table)); box-shadow:inset 0 8px 40px rgba(0,0,0,.45), 0 10px 30px rgba(0,0,0,.35); border:2px solid #0b3b8e; padding:18px; position:relative; overflow:visible; }
.seats{ position:absolute; inset:0; z-index:5; } .seat{ position:absolute; transform:translate(-50%,-50%); }
.seat-inner{ display:flex; align-items:center; gap:8px; background:rgba(0,0,0,0.28); padding:6px 8px; border-radius:12px; border:1px solid rgba(255,255,255,0.08); backdrop-filter:blur(2px); white-space:nowrap; }
.seat.turn .seat-inner{ box-shadow:0 0 0 2px var(--accent) inset, 0 0 14px rgba(34,197,94,0.45); }
.name{ font-weight:700; font-size:13px; } .last-text{ font-size:12px; color:var(--text); opacity:.95; }
.bid-center{ position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); text-align:center; z-index:1; }
.bid-center .big{ text-shadow:0 2px 8px rgba(0,0,0,.35); }
.overlay{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,.55); z-index:1000; }
.modal{ background:#0b1220; border:1px solid #1f2937; padding:20px; border-radius:18px; width:min(560px, 94vw); text-align:center; box-shadow:0 10px 40px rgba(0,0,0,.5); position:relative; overflow:hidden; }
.reveal-grid{ display:grid; grid-template-columns:1fr; gap:10px; text-align:left; }
.reveal-row{ display:flex; align-items:center; gap:10px; border:1px solid #1f2937; border-radius:12px; padding:8px; }
.reveal-name{ font-weight:700; min-width:110px; } .reveal-dice{ display:flex; flex-wrap:wrap; gap:6px; }
.count-line{ margin-top:8px; font-weight:800; font-size:18px; }
@keyframes overlayFadeOut{ from{opacity:1; transform:scale(1);} to{opacity:0; transform:scale(.98);} } .overlay.fade-out .modal{ animation:overlayFadeOut 1s ease forwards; }
@keyframes diceRollIn{ from{transform:translateY(-6px) rotate(-12deg); opacity:0;} to{transform:none; opacity:1;} }
.roll-in .die{ animation:diceRollIn 600ms ease both; }
.roll-in .die:nth-child(2){ animation-delay:.05s; } .roll-in .die:nth-child(3){ animation-delay:.1s; }
.roll-in .die:nth-child(4){ animation-delay:.15s; } .roll-in .die:nth-child(5){ animation-delay:.2s; }
.confetti-host{ position:absolute; inset:0; pointer-events:none; overflow:hidden; } .confetti{ position:absolute; width:8px; height:12px; opacity:0; transform:translateY(-20px) rotate(0deg); }
@keyframes confettiFall{ 0%{ transform:translate(var(--x,0),-30px) rotate(0deg); opacity:0; } 10%{ opacity:1; } 100%{ transform:translate(var(--x,0),520px) rotate(var(--rot,360deg)); opacity:0; } }

/* ===== Perudo cup ===== */
.cup {
  --cup: #ff5252;
  position: relative;
  width: 24px;
  height: 26px;
  flex: 0 0 24px;
  transform: rotate(180deg);
  clip-path: polygon(18% 10%, 82% 10%, 70% 96%, 30% 96%);
  background: var(--cup);
  border:1px solid rgba(0,0,0,0.35);
  box-shadow: inset 0 -2px 6px rgba(0,0,0,.35), 0 1px 2px rgba(0,0,0,.3);
}
.cup::after{
  content:''; position:absolute; left:14%; right:14%; bottom:-2px; height:3px; border-radius:3px;
  background: rgba(255,255,255,0.28);
}
@keyframes cupShake {
  0%   { transform: rotate(180deg) translateX(0) rotate(0deg); }
  10%  { transform: rotate(180deg) translateX(-1px) rotate(-2deg); }
  20%  { transform: rotate(180deg) translateX(1px) rotate(2deg); }
  30%  { transform: rotate(180deg) translateX(-1px) rotate(-2deg); }
  40%  { transform: rotate(180deg) translateX(1px) rotate(2deg); }
  50%  { transform: rotate(180deg) translateX(-1px) rotate(-2deg); }
  60%  { transform: rotate(180deg) translateX(1px) rotate(2deg); }
  70%  { transform: rotate(180deg) translateX(-1px) rotate(-1deg); }
  80%  { transform: rotate(180deg) translateX(1px) rotate(1deg); }
  90%  { transform: rotate(180deg) translateX(0) rotate(0deg); }
  100% { transform: rotate(180deg) translateX(0) rotate(0deg); }
}
.cup.shake { animation: cupShake 2s ease-in-out; }

/* ---- Lobby ---- */
.room-code{ font-weight:800; letter-spacing:1px; }
.color-picker{ display:grid; grid-template-columns:repeat(9,1fr); gap:8px; margin-top:8px; }
.swatch{ border:2px solid rgba(255,255,255,0.12); border-radius:10px; height:34px; cursor:pointer; position:relative; }
.swatch[data-color="#ffffff"]{ box-shadow: inset 0 0 0 1px rgba(0,0,0,0.35); }
.swatch.selected{ outline:3px solid #22c55e; }
.swatch .tick{ position:absolute; right:6px; top:6px; font-size:14px; display:none; }
.swatch.selected .tick{ display:block; }

.table-wrap{ display:grid; place-items:center; margin:12px 0 8px; }
.table{ width:100%; max-width:720px; aspect-ratio:1/1; border-radius:9999px; background:radial-gradient(75% 75% at 50% 30%, var(--table2), var(--table)); box-shadow:inset 0 8px 40px rgba(0,0,0,.45), 0 10px 30px rgba(0,0,0,.35); border:2px solid #0b3b8e; padding:18px; position:relative; overflow:visible; }
.seats{ position:absolute; inset:0; z-index:5; } .seat{ position:absolute; transform:translate(-50%,-50%); }
.seat-inner{ display:flex; align-items:center; gap:8px; background:rgba(0,0,0,0.28); padding:6px 8px; border-radius:12px; border:1px solid rgba(255,255,255,0.08); backdrop-filter:blur(2px); white-space:nowrap; }

/* ---- Menu dropdown ---- */
.dropdown{ position:absolute; right:0; top:44px; background:#0b1220; border:1px solid #1f2937; border-radius:12px; padding:8px; box-shadow:0 10px 24px rgba(0,0,0,.45); width:200px; z-index:1500; }
.dropdown button{ width:100%; padding:10px 12px; border-radius:10px; margin:4px 0; }
.menu-brand{ display:flex; flex-direction:column; align-items:center; justify-content:center; margin-bottom:8px; }
.menu-brand .brand{ font-size:34px; }
.menu-brand .slogan{ font-size:13px; }
.top-brand{ display:flex; flex-direction:column; align-items:flex-start; }

/* MENU-SAFE: keep in-game controls visible; no JS/menu changes */
#screen-game #controls.hidden{ display:block !important; }
</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="title top-brand">
      <div class="brand" aria-label="CUPADOO!">
        <span class="r">C</span><span class="y">U</span><span class="o">P</span><span class="r">A</span><span class="y">D</span><span class="o">O</span><span class="r">O</span><span class="y">!</span>
      </div>
      <div class="slogan">Shake it. Fake it. Take it.</div>
    </div>
    <button id="btnMenu" class="menu-btn">Menu ‚ñæ</button>
    <div id="menuDropdown" class="dropdown hidden">
      <button id="ddHome" class="link">üè† Lobby</button>
      <button id="ddCopyCode" class="link">üîó Copy room code</button>
    </div>
  </div>

  <!-- Lobby -->
  <div class="card" id="screen-lobby">
    <div class="menu-brand center">
      <div class="brand"><span class="r">C</span><span class="y">U</span><span class="o">P</span><span class="r">A</span><span class="y">D</span><span class="o">O</span><span class="r">O</span><span class="y">!</span></div>
      <div class="slogan">Multiplayer ‚Äî Firebase RTDB</div>
      <div id="versionLabel" style="margin-top:6px;text-align:center;font-weight:800;color:#e5e7eb;opacity:0.9;">Version: v41</div>
    </div>

    <div class="row">
      <div><label>Your name</label><input id="youName" type="text" placeholder="You" value="You" /></div>
      <div><label>Room code</label><input id="roomCode" type="text" placeholder="e.g. Z3Q9K" /></div>
    </div>

    <h2 style="margin-top:12px;">Cup colour</h2>
    <p class="muted" style="margin-top:-6px;">Pick your cup colour. Try to choose unique colours.</p>
    <div id="colorPicker" class="color-picker"></div>

    <div class="row" style="margin-top:12px;">
      <button id="btnHost">Create room</button>
      <button id="btnJoin" class="secondary">Join room</button>
    </div>

    <div id="lobbyInfo" class="hidden" style="margin-top:8px;">
      <p>Room: <span class="room-code" id="displayRoom">‚Äî</span> ‚Ä¢ Players (2‚Äì6):</p>
      <div class="players" id="lobbyPlayers"></div>
      <div class="row" style="margin-top:10px;">
        <button id="btnStart" class="warn" disabled>Start game (host)</button>
        <button id="btnLeave" class="danger">Leave room</button>
      </div>
    </div>
  </div>

  <!-- Game -->
  <div class="card hidden" id="screen-game">
    <div class="row">
      <div class="pill" id="roundPill">Round 1</div>
      <div class="pill" id="turnPill">Your turn</div>
      <div class="pill" id="statusPill">&nbsp;</div>
      <div class="pill" id="totalPill">Total: 0 dice</div>
      <div class="pill hidden" id="palificoPill">Palifico active</div>
      <div class="pill" id="roomPill">Room: ‚Äî</div>
    </div>

    <h2 class="center" style="margin:6px 0 4px;">Your Dice</h2>
    <div class="dice" id="yourDice"></div>

    <div class="table-wrap">
      <div class="table" id="tableBoard">
        <div id="seats" class="seats"></div>
        <div id="bidCenter" class="bid-center">
          <div class="big" id="bidText">No bid yet</div>
          <div class="muted" id="bidBy"></div>
        </div>
      </div>
    </div>

    <h2>Players</h2>
    <div class="players" id="playersList"></div>

    <div id="controls" class="footer">
      <div class="row">
        <div><label>Quantity</label><input id="qty" type="number" min="1" value="1" /></div>
        <div><label id="faceLabel">Face (2‚Äì6)</label><input id="face" type="number" min="2" max="6" value="2" /></div>
      </div>
      <div class="row" style="margin-top:8px;">
        <button id="btnBid">Make Bid</button>
        <button id="btnDudo" class="danger">Dudo</button>
        <button id="btnCalza" class="warn">Calza (Exact)</button>
      </div>
    </div>
  </div>

  <div id="toaster" class="toast hidden"></div>

  <!-- Game Over overlay -->
  <div id="overlay" class="overlay hidden">
    <div class="modal">
      <div class="confetti-host" id="confettiHost"></div>
      <h3 id="overlayTitle">Game over</h3>
      <p id="overlayText">‚Äî</p>
      <div class="row" style="margin-top:12px;">
        <button id="btnRematch">Rematch</button>
        <button id="btnMenuFromOverlay" class="secondary">Lobby</button>
      </div>
    </div>
  </div>

  <!-- Reveal overlay -->
  <div id="revealOverlay" class="overlay hidden">
    <div id="revealModal" class="modal">
      <h3 id="revealTitle">üîç Reveal</h3>
      <p class="muted" id="revealSubtitle">Showing all dice‚Ä¶</p>
      <div id="revealGrid" class="reveal-grid"></div>
      <div class="count-line" id="countLine">Matches: 0</div>
      <div class="row" style="margin-top:10px;">
        <button id="btnRevealOk">Continue</button>
      </div>
    </div>
  </div>
</div>

<!-- Firebase compat CDN -->
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-database-compat.js"></script>

<script>
(()=>{
// ===== Utils + UI helpers =====
const $=s=>document.querySelector(s),el=(t,c,x)=>{const e=document.createElement(t); if(c)e.className=c; if(x!=null)e.textContent=x; return e;},rnd=n=>1+Math.floor(Math.random()*n),roll=n=>Array.from({length:n},()=>rnd(6)),sleep=ms=>new Promise(r=>setTimeout(r,ms));
function toast(m,ms=1600){const t=$('#toaster'); t.textContent=m; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'), ms);}
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
const DEFAULT_COLORS=['#ff0000','#ff7f00','#ffe100','#7c3aed','#16a34a','#2563eb','#ec4899','#111111','#ffffff'];
const CFG_KEY='perudoCfg_mp_v1';
function loadCfg(){try{return JSON.parse(localStorage.getItem(CFG_KEY)||'{}');}catch{return{};}}
function saveCfg(cfg){localStorage.setItem(CFG_KEY, JSON.stringify(cfg));}
function randomCode(len=5){ const chars='ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; let s=''; for(let i=0;i<len;i++) s+=chars[Math.floor(Math.random()*chars.length)]; return s; }
function cupEl(color){ const c=el('div','cup'); c.style.setProperty('--cup', color); return c; }
function dieSmall(face,cls=''){const d=el('div','die small '+cls,String(face)); return d;}
function dieReveal(face,is){const d=el('div','die reveal'+(is?' match':''),String(face)); return d;}
function onesWildForFace(face,g){ return !g.palifico && face!==1; }

// ===== Firebase setup =====
const firebaseConfig = {
  apiKey: "AIzaSyA1iB1gMq2UubLhlUDvDdnQPOZ1l5utGW8",
  authDomain: "cupadoo-80273.firebaseapp.com",
  projectId: "cupadoo-80273",
  storageBucket: "cupadoo-80273.firebasestorage.app",
  messagingSenderId: "827895807709",
  appId: "1:827895807709:web:806035be2f119d3993e534",
  measurementId: "G-8MHF4LZ9JR",
  databaseURL: "https://cupadoo-80273-default-rtdb.europe-west1.firebasedatabase.app/"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ===== Identity & room refs =====
const uid = (localStorage.getItem('uid') || (()=>{ const id='u'+Math.random().toString(36).slice(2,9); localStorage.setItem('uid',id); return id; })());
let roomCode=null, isHost=false;
let roomRef=null, playersRef=null, stateRef=null, inputsRef=null;

// ===== Game state (mirrors the RTDB /state) =====
const state={ players:[], youId:uid, turnIndex:0, round:1, hands:{}, bid:null, palifico:false, palificoFace:null, roundStarterIndex:0, gameOver:false, message:'' };

// ===== Rendering =====
function renderSeats(){
  const box=$('#seats'); if(!box) return;
  const table=$('#tableBoard'); const rect=table.getBoundingClientRect(); if(rect.width===0||rect.height===0){ return; }
  box.innerHTML='';
  const w=rect.width,h=rect.height,cx=w/2,cy=h/2,r=Math.min(w,h)/2-28;
  const seated=state.players.filter(p=>p.dice>0); const n=seated.length||1;
  seated.forEach((p,idx)=>{
    const ang=(-Math.PI/2)+(idx/n)*(Math.PI*2);
    const x=cx+r*Math.cos(ang), y=cy+r*Math.sin(ang);
    const seat=el('div','seat'+(state.players.indexOf(p)===state.turnIndex?' turn':'')); seat.style.left=x+'px'; seat.style.top=y+'px';
    const inner=el('div','seat-inner');
    inner.appendChild(cupEl(p.cup));
    const name=el('div','name', p.name+(p.id===uid?' (You)':'')); inner.appendChild(name);
    const lc=p.lastChoice;
    if(lc&&lc.type==='bid'){ inner.appendChild(el('span','last-text',`${lc.qty} √ó ${lc.face}'s`)); inner.appendChild(dieSmall(lc.face)); }
    else if(lc&&lc.type==='dudo'){ inner.appendChild(el('div','dudo-badge','DUDO')); }
    else if(lc&&lc.type==='calza'){ inner.appendChild(el('div','dudo-badge','CALZA')); }
    else inner.appendChild(el('span','last-text','‚Äî'));
    seat.appendChild(inner); box.appendChild(seat);
  });
}
function renderSeatsDeferred(){ requestAnimationFrame(renderSeats); }
function renderPlayersList(){
  const box=$('#playersList'); box.innerHTML='';
  state.players.forEach((p,idx)=>{
    const row=el('div','player'+(p.id===uid?' you':'')+(idx===state.turnIndex?' turn':''));
    const left=el('div','player-left'); left.appendChild(cupEl(p.cup));
    const nb=el('div'); nb.appendChild(el('div','', p.name+(p.id===uid?' (You)':'')));
    nb.appendChild(el('div','muted', p.dice>0 ? (p.dice+' dice') : '0 dice'));
    left.appendChild(nb);
    const right=el('div','player-right'); const lc=p.lastChoice;
    if(lc&&lc.type==='bid'){ right.appendChild(el('span','tag',`${lc.qty} √ó ${lc.face}'s`)); right.appendChild(dieSmall(lc.face)); }
    else if(lc&&lc.type==='dudo'){ right.appendChild(el('div','dudo-badge','DUDO')); }
    else if(lc&&lc.type==='calza'){ right.appendChild(el('div','dudo-badge','CALZA')); }
    else right.appendChild(el('span','tag','‚Äî'));
    if(p.dice<=0){ right.appendChild(el('span','skull','üíÄ')); }
    right.appendChild(el('span','pill', p.id===uid?'You':'P'+(idx+1)));
    row.append(left,right); box.appendChild(row);
  });
}
function renderYourDice(){ const box=$('#yourDice'); box.innerHTML=''; (state.hands[uid]||[]).forEach(v=> box.appendChild(el('div','die', String(v)))); }
function renderBid(){
  if(!state.bid){ $('#bidText').textContent='No bid yet'; $('#bidBy').textContent=''; return; }
  $('#bidText').textContent=`${state.bid.qty} √ó ${state.bid.face}'s${state.palifico?' ‚Ä¢ PALIFICO':''}${state.bid.face===1?' ‚Ä¢ ACES':''}`;
  const by=state.players.find(p=>p.id===state.bid.by);
  $('#bidBy').textContent=`by ${by?by.name:'Unknown'}`;
  setFirstBidControls();
}
function renderStatus(){
  $('#roundPill').textContent=`Round ${state.round}`;
  const turn=state.players[state.turnIndex];
  $('#turnPill').textContent= turn? `${turn.name}'s turn` : '‚Äî';
  $('#totalPill').textContent=`Total: ${totalDiceAlive(state)} dice`;
  $('#roomPill').textContent= roomCode ? `Room: ${roomCode}` : 'Room: ‚Äî';
  $('#statusPill').textContent= state.message || '';
}
function renderControls(){
  const myTurn = state.players[state.turnIndex]?.id===uid;
  const show = myTurn && !state.reveal && !state.gameOver;
  $('#controls').classList.toggle('hidden', !show);
  const calzaBtn=$('#btnCalza'); if(calzaBtn){ calzaBtn.disabled = state.palifico; calzaBtn.classList.toggle('hidden', state.palifico); }
  setFirstBidControls();
}
function render(){ renderSeatsDeferred(); renderPlayersList(); renderYourDice(); renderBid(); renderStatus(); renderControls(); }

// ===== Game helpers adapted to shared state =====
function alivePlayers(g=state){ return g.players.filter(p=>p.dice>0); }
function totalDiceAlive(g=state){ return g.players.reduce((s,p)=>s+(p.dice>0?p.dice:0),0); }
function nextAliveFrom(idx,g=state){ const n=g.players.length; for(let st=1;st<=n;st++){const i=(idx+st)%n; if(g.players[i].dice>0) return i;} return idx; }
function isValidRaise(qty,face,g=state){
  const numAlive = alivePlayers(g).length;
  if(!g.bid){
    if(g.palifico){
      if(numAlive>2){
        if(g.palificoFace==null) return false;
        return face===g.palificoFace && qty>=1;
      }else{
        return qty>=1 && face>=1 && face<=6;
      }
    }else{
      if(face===1) return false;
      return qty>=1 && face>=2 && face<=6;
    }
  }
  const b=g.bid;
  if(g.palifico){
    const locked=g.palificoFace ?? b.face;
    if(g.palificoFace==null) g.palificoFace=b.face;
    if(face!==locked) return false;
    return qty>b.qty;
  } else {
    if(b.face===face){ return qty>b.qty; }
    else if(face===1 && b.face!==1){ return qty>=Math.ceil(b.qty/2); }
    else if(b.face===1 && face!==1){ return qty>=(b.qty*2+1); }
    else { return (qty>b.qty) || (qty===b.qty && face>b.face); }
  }
}
function setFirstBidControls(){
  const faceInput=$('#face'), faceLabel=$('#faceLabel'); const numAlive=alivePlayers().length;
  if(!state.bid){
    if(state.palifico){
      if(numAlive>2 && state.palificoFace!=null){
        faceInput.min=faceInput.max=state.palificoFace; faceInput.value=state.palificoFace; faceInput.disabled=true; faceLabel.textContent=`Face (locked: ${state.palificoFace})`;
      }else{ faceInput.min=1; faceInput.max=6; faceInput.disabled=false; faceLabel.textContent='Face (1‚Äì6)'; }
    }else{ faceInput.min=2; faceInput.max=6; faceInput.disabled=false; if(parseInt(faceInput.value,10)<2) faceInput.value=2; faceLabel.textContent='Face (2‚Äì6)'; }
  }else{
    if(state.palifico && state.palificoFace!=null){
      faceInput.min=faceInput.max=state.palificoFace; faceInput.value=state.palificoFace; faceInput.disabled=true; faceLabel.textContent=`Face (locked: ${state.palificoFace})`;
    }else{ faceInput.min=1; faceInput.max=6; faceInput.disabled=false; faceLabel.textContent='Face (1‚Äì6)'; }
  }
}

// ===== Host-authoritative game logic =====
function startRoundHost(startTurnIndex=null){
  /*__RESET_LASTCHOICE__*/
  if(Array.isArray(state.players)){
    state.players = state.players.map(p=> ({...p, lastChoice:null}));
  }
  // v17: round-safe init (do NOT touch roster)
  // Reset only per-round fields
  state.bid = null;
  state.message = null;
  state.palifico = false;
  state.palificoFace = null;
  state.reveal = null;

  state.bid=null;
  if(startTurnIndex!=null) state.turnIndex=startTurnIndex;
  state.roundStarterIndex=state.turnIndex;
  state.palifico=(state.players[state.roundStarterIndex]?.dice===1);
  state.palificoFace=null;
  // Clear last round choices so UI shows 'No bid yet'
  state.players = state.players.map(p=> ({...p, lastChoice: null}));
  // roll hands
  state.hands={};
  for(const p of state.players) state.hands[p.id]=p.dice>0?roll(p.dice):[];
  if(state.palifico){
    const numAlive=alivePlayers().length;
    if(numAlive>2){
      const starter=state.players[state.roundStarterIndex];
      const dieVal=(state.hands[starter.id]||[])[0]||1;
      state.palificoFace=dieVal;
      state.message=`Palifico: everyone bids ${dieVal} ‚Ä¢ 1s not wild ‚Ä¢ no Calza`;
    } else {
      state.message=`Palifico (heads-up): first bid chooses face ‚Ä¢ 1s not wild ‚Ä¢ no Calza`;
    }
  }else{
    state.message='';
  }
  state.reveal=null;
  syncState();
}
function makeBidHost(byId, qty, face){
  if(!isValidRaise(qty,face)){ toast('Invalid bid'); return; }
  if(state.palifico && state.palificoFace==null) state.palificoFace=face;
  state.bid={qty,face,by:byId};
  state.message='';
  setLastChoice(byId,{type:'bid', qty, face});
  const curIndex=state.players.findIndex(p=>p.id===byId);
  state.turnIndex=nextAliveFrom(curIndex);
  syncState();
}
function setLastChoice(forId,choice){
  state.players=state.players.map(p=> (p.id===forId? {...p, lastChoice: choice } : p));
}
function countMatches(face,g=state){
  const ow=onesWildForFace(face,g);
  let t=0;
  for(const hand of Object.values(g.hands)) for(const d of hand) if(d===face || (ow&&d===1)) t++;
  return t;
}
async function handleDudoHost(callerId){
  if(!state.bid) return;
  state.reveal={ type:'dudo', face:state.bid.face, total: countMatches(state.bid.face), title:'üîç Dudo Reveal' };
  syncState(); // everyone shows overlay
}
async function handleCalzaHost(callerId){
  if(state.palifico || !state.bid) return;
  state.reveal={ type:'calza', face:state.bid.face, total: countMatches(state.bid.face), title:'üéØ Calza (Exact)' };
  syncState();
}
function finishRevealAndResolveHost(callerId){
  const type=state.reveal?.type; if(!type) return;
  const total=state.reveal.total;
  if(type==='dudo'){
    const bidder=state.players.find(p=>p.id===state.bid.by);
    const caller=state.players.find(p=>p.id===callerId);
    let loser=caller, reason='';
    if(total>=state.bid.qty){ loser=caller; reason=`Dudo failed: ${total} ‚â• ${state.bid.qty}.`; }
    else { loser=bidder; reason=`Dudo success: ${total} < ${state.bid.qty}.`; }
    endOfRoundHost(loser, reason);
  } else if(type==='calza'){
    const caller=state.players.find(p=>p.id===callerId);
    if(total===state.bid.qty){
      caller.dice=Math.min(8, caller.dice+1);
      const idx=state.players.indexOf(caller);
      state.round+=1; state.reveal=null; state.message=`Calza correct! Exactly ${total}. ${caller.name} gains a die.`;
      startRoundHost(idx);
    } else {
      state.message=`Calza wrong: ${total} (needed exactly ${state.bid.qty}). ${caller.name} loses a die.`;
      endOfRoundHost(caller, state.message);
    }
  }
}
function endOfRoundHost(loser, reason){
  // v17: snapshot roster before any changes
  try{ window.__lastPlayersSnapshot = JSON.parse(JSON.stringify(state.players||[])); }catch(e){}

  if(loser) loser.dice=Math.max(0, loser.dice-1);
  state.reveal=null;
  const alive=alivePlayers();
  if(alive.length<=1){
    const winner=alive[0]||null;
    const msg=`${winner?.name||'Nobody'} wins!`;
    state.gameOver=true; state.message=msg; syncState();
    return;
  }
  const loserIdx=state.players.indexOf(loser);
  const startIdx=loser.dice>0 ? loserIdx : nextAliveFrom(loserIdx);
  state.round+=1; state.message=reason;
  startRoundHost(startIdx);
}


// ===== Turn helper (menu-safe) =====
function isMyTurn(){
  try{
    const cur = state && state.players && state.players[state.turnIndex];
    const ok = !!(cur && cur.id === uid);
    return ok && !state.reveal && !state.gameOver;
  }catch(e){ return false; }
}

// ===== RTDB sync =====
function syncState(){ try{ if(stateRef) stateRef.set(state); }catch(e){ console.error('syncState failed', e); } }
function syncAll(){
  // v17: full write when dice actually change
  if(!Array.isArray(state.players)||!state.players.length){
    if(Array.isArray(window.__lastPlayersSnapshot)&&window.__lastPlayersSnapshot.length){
      state.players = JSON.parse(JSON.stringify(window.__lastPlayersSnapshot));
    }
  } else {
    try{ window.__lastPlayersSnapshot = JSON.parse(JSON.stringify(state.players)); }catch(e){}
  }
  if(stateRef) stateRef.set(state);
}
function syncPartial(patch){
  // v17: small safe updates (never touch players array)
  const patchSafe = Object.assign({}, patch||{});
  if('players' in patchSafe) delete patchSafe.players;
  if(stateRef) stateRef.update(patchSafe);
}
function processInput(a){
  // Validate whose turn
  const curId=state.players[state.turnIndex]?.id;
  if(a.by!==curId && !(a.type==='continueReveal' && isHost)) return; // ignore out-of-turn (or allow host to continue)
  if(a.type==='bid'){ makeBidHost(a.by, a.qty, a.face); }
  if(a.type==='dudo'){ setLastChoice(a.by,{type:'dudo'}); handleDudoHost(a.by); syncState(); }
  if(a.type==='calza'){ setLastChoice(a.by,{type:'calza'}); handleCalzaHost(a.by); syncState(); }
  if(a.type==='continueReveal'){ finishRevealAndResolveHost(a.by); syncState(); }
}


// ===== Start button reliability helpers (menu-safe) =====
let __lobbyCount = 0;
function updateStartEnabled(){
  try{
    const btn = document.getElementById('btnStart');
    if(!btn) return;
    btn.disabled = !(isHost && __lobbyCount>=2 && __lobbyCount<=6);
  }catch(e){}
}

// ===== Presence & lobby =====
const lobby = { players: new Map() };
function renderLobbyPlayers(list){
  const box=$('#lobbyPlayers'); box.innerHTML='';
  list.forEach(p=>{
    const row=el('div','player'+(p.id===uid?' you':''));
    const left=el('div','player-left'); left.appendChild(cupEl(p.cup||'#ff0000'));
    const nb=el('div'); nb.appendChild(el('div','', p.name+(p.id===uid?' (You)':'')));
    nb.appendChild(el('div','muted', p.connected?'online':'offline'));
    left.appendChild(nb);
    const right=el('div','player-right'); right.appendChild(el('span','pill', p.id===state.hostId?'Host':'Player'));
    row.append(left,right); box.appendChild(row);
  });
}
function enterLobbyUI(code){
  $('#lobbyInfo').classList.remove('hidden');
  $('#displayRoom').textContent=code;
  $('#btnStart').disabled=true;
}
function leaveLobbyUI(){
  $('#lobbyInfo').classList.add('hidden');
  $('#displayRoom').textContent='‚Äî';
}
function goToLobby(){ $('#screen-lobby').classList.remove('hidden'); $('#screen-game').classList.add('hidden'); }
function goToGame(){ $('#screen-lobby').classList.add('hidden'); $('#screen-game').classList.remove('hidden'); renderSeatsDeferred(); }


function attachRoomListeners(){
  // Keep host status synced from DB
  if(roomRef){
    roomRef.on('value', snap=>{
      const room = snap.val()||{};
      isHost = (room.hostId===uid);
      updateStartEnabled();
    });
  }
  playersRef.on('value', snap=>{
    const vals=snap.val()||{};
    const arr=Object.values(vals).map(v=>({...v})).sort((a,b)=> (a.joinTs||0)-(b.joinTs||0));
    renderLobbyPlayers(arr);
    __lobbyCount = arr.filter(p=>p.connected!==false).length || arr.length;
    updateStartEnabled();
  });
  // Host consumes inputs
  inputsRef.on('child_added', s=>{
    if(!isHost) return;
    const a=s.val(); processInput(a);
    s.ref.remove();
  });
  // State updates -> render game
  stateRef.on('value', snap=>{
    const g=snap.val();
    if(!g) return;
    Object.assign(state, g);
    if(g.status==='playing' || g.players?.length){
      goToGame();
      render();
      if(g.reveal){ showRevealOverlay(g.reveal); } else { hideRevealOverlay(); }
      if(g.gameOver){ showGameOver(g.message||'Game over'); }
    }
  });
}

function detachRoomListeners(){
  if(playersRef){ playersRef.off(); }
  if(inputsRef){ inputsRef.off(); }
  if(stateRef){ stateRef.off(); }
}

async function createRoom(){
  const code=randomCode();
  roomCode=code; isHost=true;
  roomRef=db.ref('rooms/'+code);
  playersRef=roomRef.child('players');
  inputsRef=roomRef.child('inputs');
  stateRef=roomRef.child('state');
  await roomRef.set({ createdAt: firebase.database.ServerValue.TIMESTAMP, status:'lobby', hostId:uid });
  await joinSelf();
  enterLobbyUI(code);
  attachRoomListeners();
  toast('Room created');
}
async function joinRoom(code){
  code=(code||'').toUpperCase().trim();
  if(!code){ toast('Enter a room code'); return; }
  roomCode=code; isHost=false;
  roomRef=db.ref('rooms/'+code);
  const snap=await roomRef.get();
  if(!snap.exists()){ toast('Room not found'); return; }
  playersRef=roomRef.child('players'); inputsRef=roomRef.child('inputs'); stateRef=roomRef.child('state');
  enterLobbyUI(code);
  await joinSelf();
  attachRoomListeners();
  toast('Joined room');
}
async function joinSelf(){
  const cfg=loadCfg();
  const name = ($('#youName').value||cfg.youName||'You').slice(0,24);
  const cup = cfg.youCup || DEFAULT_COLORS[0];
  saveCfg({ ...cfg, youName:name, youCup: cup });
  const myRef = playersRef.child(uid);
  await myRef.set({ id:uid, name, cup, connected:true, joinTs: firebase.database.ServerValue.TIMESTAMP });
  myRef.onDisconnect().remove();
}
async function leaveRoom(){
  try{ await playersRef.child(uid).remove(); }catch{}
  detachRoomListeners();
  roomRef=null; playersRef=null; stateRef=null; inputsRef=null;
  roomCode=null; isHost=false; leaveLobbyUI(); goToLobby();
  toast('Left room');
}

// ===== Start game (host) =====

async function hostStart(){
  try{
    const startBtn = document.getElementById('btnStart');
    if(startBtn && startBtn.disabled){ toast('Waiting for another player (need 2‚Äì6) or not host'); return; }

    if(!roomRef){ toast('No room. Create or join first.'); return; }
    const roomSnap = await roomRef.get();
    const room = roomSnap.val()||{};
    if(room.hostId!==uid){ toast('Only the host can start the game'); return; }

    const snap=await playersRef.get();
    const vals=snap.val()||{};
    let arr=Object.values(vals).map(v=>({id:v.id, name:v.name, cup:v.cup, dice:5}));
    if(arr.length<2){ toast('Need at least 2 players'); return; }

    arr=shuffle(arr);
    state.players=arr; state.round=1; state.gameOver=false; state.message=''; state.status='playing';
    state.hostId=uid;
    const aliveIdx = state.players.map((p,i)=> p.dice>0 ? i : -1).filter(i=>i>=0);
    const startIdx = aliveIdx[Math.floor(Math.random()*aliveIdx.length)] ?? 0;
    startRoundHost(startIdx);
    syncState();
    toast('Game started');
  }catch(e){
    console.error('[hostStart error]', e);
    toast('Start failed: '+(e.message||e));
  }
}


// ===== Reveal overlay behaviour =====
function buildRevealGrid(face){
  const ow=onesWildForFace(face,state);
  const grid=$('#revealGrid'); grid.innerHTML='';
  for(const p of state.players){
    const row=el('div','reveal-row'); row.appendChild(cupEl(p.cup));
    row.appendChild(el('div','reveal-name', p.name+(p.id===uid?' (You)':'')));
    const strip=el('div','reveal-dice');
    (state.hands[p.id]||[]).forEach(v=>{ const is=(v===face || (ow && v===1)); strip.appendChild(dieReveal(v,is)); });
    row.appendChild(strip); grid.appendChild(row);
  }
}
async function showRevealOverlay(rev){
  if(!rev) return;
  $('#revealTitle').textContent=rev.title || 'üîç Reveal';
  const ow=onesWildForFace(rev.face,state);
  $('#revealSubtitle').textContent=`Counting dice for face ${rev.face}${ow? ' (1s are wild)‚Ä¶' : ' (1s do not count)‚Ä¶'}`;
  buildRevealGrid(rev.face); $('#revealOverlay').classList.remove('hidden');
  const total=rev.total||0;
  const line=$('#countLine'); line.textContent='Matches: 0'; let cur=0;
  while(cur<total){ await sleep(120); cur++; line.textContent=`Matches: ${cur}`; }
  // Host continues; others wait
  const btn=$('#btnRevealOk');
  btn.disabled=!isHost;
  btn.textContent = isHost ? 'Continue' : 'Waiting for host‚Ä¶';
}
function hideRevealOverlay(){ $('#revealOverlay').classList.add('hidden'); }

// ===== Game over overlay =====

function launchConfetti(){
  try{
    const host = document.getElementById('confettiHost');
    if(!host) return;
    host.innerHTML='';
    const colors = (window.state?.players||[]).map(p=>p.cup).filter(Boolean);
    const palette = colors.length ? colors : ['#ff5252','#ffd60a','#22c55e','#2563eb','#ec4899','#111111','#ffffff'];
    let running = true;
    // clear old interval if any
    if(window.__confettiTimer){ clearInterval(window.__confettiTimer); }
    window.__confettiTimer = setInterval(()=>{
      if(!running) return;
      const d = document.createElement('div');
      d.className='confetti';
      d.style.left = (Math.random()*100)+'%';
      d.style.setProperty('--x', (Math.random()*160-80)+'px');
      d.style.setProperty('--rot', (Math.random()*540)+'deg');
      d.style.background = palette[Math.floor(Math.random()*palette.length)];
      d.style.animation = 'confettiFall '+(2.5+Math.random()*1.5)+'s ease-out forwards';
      const hostNow = document.getElementById('confettiHost');
      if(hostNow) hostNow.appendChild(d);
    }, 120);
  }catch(e){ /* ignore */ }
}
function showGameOver(text){
  $('#overlayTitle').textContent='Game over';
  $('#overlayText').textContent=text||'‚Äî';
  $('#overlay').classList.remove('hidden');
  launchConfetti();
}
function hideOverlay(){
  $('#overlay').classList.add('hidden');
  if(window.__confettiTimer){ clearInterval(window.__confettiTimer); window.__confettiTimer=null; }
}
function showGameOver(text){
  $('#overlayTitle').textContent='Game over';
  $('#overlayText').textContent=text||'‚Äî';
  $('#overlay').classList.remove('hidden');
  launchConfetti();
}
function hideOverlay(){ $('#overlay').classList.add('hidden'); }

// ===== UI events =====
document.getElementById('btnHost').addEventListener('click', ()=> createRoom());
document.getElementById('btnJoin').addEventListener('click', ()=> joinRoom($('#roomCode').value));
document.getElementById('btnLeave').addEventListener('click', ()=> leaveRoom());
document.getElementById('btnStart').addEventListener('click', ()=> hostStart());
document.getElementById('btnRematch').addEventListener('click', ()=>{ hideOverlay(); if(isHost){ hostStart(); }});
document.getElementById('btnMenuFromOverlay').addEventListener('click', ()=>{ hideOverlay(); goToLobby(); });

document.getElementById('btnBid').addEventListener('click', ()=>{
  if(!isMyTurn()){ const cur = state.players && state.players[state.turnIndex]; toast(`It's ${cur?cur.name:'another player'}'s turn`); return; }

  const q=parseInt($('#qty').value,10)||1; const f=Math.max(1,Math.min(6,parseInt($('#face').value,10)||1));
  if(isHost){ makeBidHost(uid,q,f); } else { inputsRef.push({type:'bid', qty:q, face:f, by:uid, ts: firebase.database.ServerValue.TIMESTAMP}); }
});
document.getElementById('btnDudo').addEventListener('click', ()=>{
  if(!isMyTurn()){ const cur = state.players && state.players[state.turnIndex]; toast(`It's ${cur?cur.name:'another player'}'s turn`); return; }

  if(isHost){ setLastChoice(uid,{type:'dudo'}); handleDudoHost(uid); syncState(); } else { inputsRef.push({type:'dudo', by:uid, ts: firebase.database.ServerValue.TIMESTAMP}); }
});
document.getElementById('btnCalza').addEventListener('click', ()=>{
  if(!isMyTurn()){ const cur = state.players && state.players[state.turnIndex]; toast(`It's ${cur?cur.name:'another player'}'s turn`); return; }

  if(isHost){ setLastChoice(uid,{type:'calza'}); handleCalzaHost(uid); syncState(); } else { inputsRef.push({type:'calza', by:uid, ts: firebase.database.ServerValue.TIMESTAMP}); }
});
document.getElementById('btnRevealOk').addEventListener('click', ()=>{
  if(isHost){ inputsRef.push({type:'continueReveal', by:uid, ts: firebase.database.ServerValue.TIMESTAMP}); }
});

// Keep seats responsive
const table = document.getElementById('tableBoard');
if('ResizeObserver' in window){ new ResizeObserver(()=> renderSeatsDeferred()).observe(table); } else { window.addEventListener('resize', renderSeatsDeferred); }

// Menu dropdown
const btnMenu = document.getElementById('btnMenu');
const dd = document.getElementById('menuDropdown');
function closeDD(){ dd.classList.add('hidden'); }
btnMenu.addEventListener('click', (e)=>{ e.stopPropagation(); dd.classList.toggle('hidden'); });
document.addEventListener('click', ()=> closeDD());
document.getElementById('ddHome').addEventListener('click', ()=>{ closeDD(); goToLobby(); });
document.getElementById('ddCopyCode').addEventListener('click', async ()=>{
  closeDD(); if(!roomCode){ toast('No room yet'); return; }
  try{ await navigator.clipboard.writeText(roomCode); toast('Room code copied'); }catch{ toast('Room: '+roomCode); }
});

// Color picker (persist choice)
function renderColorPicker(){
  const cfg=loadCfg();
  const box = document.getElementById('colorPicker'); box.innerHTML='';
  const chosen = cfg.youCup || DEFAULT_COLORS[0];
  DEFAULT_COLORS.forEach(col=>{
    const sw = document.createElement('div');
    sw.className='swatch'; sw.dataset.color=col; sw.style.background=col;
    if(col.toLowerCase()===chosen.toLowerCase()) sw.classList.add('selected');
    const tick=document.createElement('div'); tick.className='tick'; tick.textContent='‚úì'; sw.appendChild(tick);
    sw.addEventListener('click', ()=>{
      document.querySelectorAll('.swatch').forEach(s=>s.classList.remove('selected'));
      sw.classList.add('selected');
      const cfg=loadCfg(); saveCfg({...cfg, youCup: col});
      toast('Cup colour saved');
    });
    box.appendChild(sw);
  });
}
renderColorPicker();
// Restore saved name
const cfg=loadCfg(); if(cfg.youName) $('#youName').value = cfg.youName;

// Toast helper for first-time hint
toast('Create or join a room to begin');

})();</script>

<!-- v17 guards: ignore bad snapshots & reseed turn -->
<script>
(function(){
  let lastGood=null;
  function clone(o){ try{return JSON.parse(JSON.stringify(o));}catch(e){return null;} }
  function valid(s){
    return s && Array.isArray(s.players) && s.players.length && typeof s.turnIndex==='number' && s.players[s.turnIndex];
  }
  function firstAlive(s){ for(let i=0;i<(s.players||[]).length;i++){ if(s.players[i]&&s.players[i].dice>0) return i; } return 0; }
  function nextAliveFrom(i,s){ const n=s.players.length; for(let k=1;k<=n;k++){ const j=(i+k)%n; if(s.players[j]&&s.players[j].dice>0) return j; } return (i+1)%n; }
  function reseed(){
    const s=window.state||{};
    if(!Array.isArray(s.players)||!s.players.length){
      const snap = (window.__lastPlayersSnapshot && window.__lastPlayersSnapshot.length && window.__lastPlayersSnapshot) || null;
      if(snap){ s.players = clone(snap); }
    }
    if(Array.isArray(s.players)&&s.players.length){
      if(typeof s.turnIndex!=='number' || !s.players[s.turnIndex] || s.players[s.turnIndex].dice<=0){
        if(s.bid){
          const i=s.players.findIndex(p=>p.id===s.bid.by);
          if(i>=0) s.turnIndex=nextAliveFrom(i,s);
        }
        if(typeof s.turnIndex!=='number' || !s.players[s.turnIndex]) s.turnIndex=firstAlive(s);
      }
    }
    if(typeof window.render==='function'){ try{ window.render(); }catch(e){} }
    if(typeof window.renderControls==='function'){ try{ window.renderControls(); }catch(e){} }
  }
  // Save last good state
  setInterval(function(){
    if(valid(window.state)){ lastGood=clone(window.state); window.__lastPlayersSnapshot = clone(window.state.players); }
  }, 400);
  // After any remote update, validate & heal
  const attach=setInterval(function(){
    if(window.stateRef && stateRef.on){ try{ stateRef.on('value', function(){ setTimeout(function(){ if(!valid(window.state) && lastGood){ window.state=clone(lastGood); reseed(); } },0); }); clearInterval(attach);}catch(e){} }
  }, 400);
})();
</script>


<!-- v23+v25: menu-safe state mirror + identity persistence + robust isMyTurn -->
<script>
(function(){
  try{
    // ----- v23: mirror /state snapshots to window.state
    if (!window.__stateMirrorV23) {
      window.__stateMirrorV23 = true;
      function safe(fn){ try{ fn(); }catch(e){} }
      function wrapOn(Ref){
        if(!Ref || !Ref.prototype || Ref.prototype.__onWrappedV23) return;
        const _on = Ref.prototype.on;
        Ref.prototype.on = function(eventType, callback){
          if(eventType==='value' && (this.key==='state')){
            const wrapped = function(snap){
              safe(()=>{ window.state = snap && snap.val ? snap.val() : snap; });
              return callback && callback.apply(this, arguments);
            };
            return _on.apply(this, [eventType, wrapped].concat([].slice.call(arguments,2)));
          }
          return _on.apply(this, arguments);
        };
        Ref.prototype.__onWrappedV23 = true;
      }
      safe(()=> wrapOn(firebase.database.Reference));
      safe(()=> { const r = (firebase && firebase.database && firebase.database.Reference) ? firebase.database.Reference : null; wrapOn(r); });
    }

    // ----- v25: persist name + robust isMyTurn (uid OR stored name)
    if(!window.__v25Injected){
      window.__v25Injected = true;

      function persistName(){
        try{
          const el = document.getElementById('name');
          const val = el && el.value ? String(el.value).trim() : null;
          if(val) localStorage.setItem('cupadoo_name', val);
        }catch(e){}
      }
      setInterval(persistName, 1000);

      function ensureUid(){
        try{
          if(!window.uid && window.firebase && firebase.auth){
            const u = (firebase.auth().currentUser||{}).uid;
            if(u){ window.uid = u; localStorage.setItem('cupadoo_uid', u); }
          }
          if(!window.uid){
            const u2 = localStorage.getItem('cupadoo_uid');
            if(u2){ window.uid = u2; }
          }
        }catch(e){}
      }

      function getStoredName(){
        try{
          const el = document.getElementById('name');
          const ui = el && el.value ? String(el.value).trim() : '';
          if(ui) return ui;
          const ls = localStorage.getItem('cupadoo_name') || '';
          return ls;
        }catch(e){ return ''; }
      }

      window.isMyTurn = function(){
        try{
          ensureUid();
          const s = window.state || {};
          const ps = s.players || [];
          const cur = ps && ps[s.turnIndex];
          if(!cur || s.reveal || s.gameOver) return false;

          const myName = getStoredName();
          const meById   = ps.find(p=> p && p.id   === window.uid);
          const meByName = ps.find(p=> p && p.name === myName);

          const sameId   = !!(cur && meById   && cur.id   && cur.id   === meById.id);
          const sameName = !!(cur && meByName && cur.name && cur.name === meByName.name);

          return sameId || sameName;
        }catch(e){ return false; }
      };
    }
  }catch(e){}
})();
</script>


<!-- v26: robust Eruda loader (always show console; triple‚Äëtap to toggle) -->
<script>
(function(){
  try{
    if(window.__erudaV26) return; window.__erudaV26 = true;
    function loadEruda(cb){
      var s=document.createElement('script');
      s.src='https://cdn.jsdelivr.net/npm/eruda';
      s.onload=function(){ try{ eruda.init(); eruda.show(); if(cb) cb(); }catch(e){} };
      s.onerror=function(){ if(cb) cb(new Error('eruda load error')); };
      document.body.appendChild(s);
    }
    function ensureEruda(){
      try{
        if(window.eruda){ try{ eruda.init(); eruda.show(); }catch(e){} return; }
        loadEruda();
      }catch(e){}
    }
    // Try on DOM ready, and a few retries
    if(document.readyState==='complete' || document.readyState==='interactive'){ ensureEruda(); }
    else document.addEventListener('DOMContentLoaded', ensureEruda);
    setTimeout(ensureEruda, 1200);
    setTimeout(ensureEruda, 4000);

    // Triple‚Äëtap anywhere to toggle eruda
    (function(){
      var taps=0, last=0;
      document.addEventListener('touchend', function(){
        var now=Date.now();
        if(now-last<450) taps++; else taps=1;
        last=now;
        if(taps>=3){
          taps=0;
          try{
            if(window.eruda){ if(eruda._isShow){ eruda.hide(); } else { eruda.show(); } }
            else ensureEruda();
          }catch(e){}
        }
      }, true);
    })();
  }catch(e){}
})();
</script>


<!-- v27: menu-safe identity harden + isMyTurn fallback via '(You)' label -->
<script>
(function(){
  try{
    if(window.__v27Injected) return; window.__v27Injected = true;

    // ---- Persist name aggressively in lobby ----
    function readNameInput(){
      const el = document.getElementById('name');
      return el && el.value ? String(el.value).trim() : '';
    }
    function saveName(val){
      if(!val) return;
      try{ localStorage.setItem('cupadoo_name', val); }catch(e){}
    }
    // Save on input events if present
    (function attachNameListeners(){
      try{
        const el = document.getElementById('name');
        if(!el) return;
        ['change','input','blur'].forEach(ev=> el.addEventListener(ev, ()=> saveName(readNameInput()), true));
        // immediate save
        saveName(readNameInput());
      }catch(e){}
    })();
    // Also poll a bit during lobby phase
    let polls=0; const pollId = setInterval(()=>{
      polls++; saveName(readNameInput());
      if(polls>120) clearInterval(pollId); // ~48s if 400ms
    }, 400);

    // ---- Helper to derive my name from UI if input/LS missing ----
    function deriveNameFromUI(){
      try{
        // Look for any element that contains "(You" and grab preceding text
        const walker = document.createTreeWalker(document.body, NodeFilter.SHOW_ELEMENT, null, false);
        while(walker.nextNode()){
          const n = walker.currentNode;
          const t = (n.textContent||'').trim();
          if(!t) continue;
          const idx = t.indexOf('(You');
          if(idx>0){
            const name = t.slice(0, idx).trim().replace(/[:¬∑‚Ä¢-]+$/,'').trim();
            if(name) return name;
          }
        }
      }catch(e){}
      return '';
    }

    function getMyName(){
      const ui = readNameInput();
      if(ui) return ui;
      try{
        const ls = localStorage.getItem('cupadoo_name')||'';
        if(ls) return ls;
      }catch(e){}
      const d = deriveNameFromUI();
      return d;
    }

    function ensureUid(){
      try{
        if(!window.uid && window.firebase && firebase.auth){
          const u = (firebase.auth().currentUser||{}).uid;
          if(u){ window.uid=u; try{localStorage.setItem('cupadoo_uid', u);}catch(e){} }
        }
        if(!window.uid){
          const u2 = localStorage.getItem('cupadoo_uid');
          if(u2){ window.uid=u2; }
        }
      }catch(e){}
    }

    // ---- Override isMyTurn with robust logic (id OR name OR UI '(You)') ----
    window.isMyTurn = function(){
      try{
        ensureUid();
        const s = window.state || {};
        const ps = Array.isArray(s.players) ? s.players : [];
        const cur = ps && ps[s.turnIndex];
        if(!cur || s.reveal || s.gameOver) return false;

        const myName = getMyName();
        const meById   = ps.find(p=> p && p.id   === window.uid);
        const meByName = ps.find(p=> p && p.name === myName);

        const sameId   = !!(cur && meById   && cur.id   && cur.id   === meById.id);
        const sameName = !!(cur && meByName && cur.name && cur.name === meByName.name);

        return sameId || sameName;
      }catch(e){ return false; }
    };
  }catch(e){}
})();
</script>


<!-- v28: improved '(You)' name extraction and persistence -->
<script>
(function(){
  try{
    if(window.__v28Injected) return; window.__v28Injected = true;

    function saveName(val){
      if(!val) return;
      try{ localStorage.setItem('cupadoo_name', val); }catch(e){}
    }

    // Find the *best* candidate "Name (You)" with shortest name fragment
    function deriveNameFromUI(){
      try{
        let best = '';
        let bestLen = 1e9;
        const walker = document.createTreeWalker(document.body, NodeFilter.SHOW_ELEMENT, null, false);
        while(walker.nextNode()){
          const t = (walker.currentNode.textContent || '').replace(/\s+/g,' ').trim();
          if(!t) continue;
          const m = t.match(/(.{1,24})\s*\(You\)/i);
          if(m && m[1]){
            const cand = m[1].trim().replace(/[:¬∑‚Ä¢-]+$/,'').trim();
            if(cand && cand.length < bestLen){
              best = cand;
              bestLen = cand.length;
            }
          }
        }
        if(best) saveName(best);
        return best;
      }catch(e){ return ''; }
    }

    function getStoredName(){
      try{
        const el = document.getElementById('name');
        const ui = el && el.value ? String(el.value).trim() : '';
        if(ui){ saveName(ui); return ui; }
        const ls = localStorage.getItem('cupadoo_name') || '';
        if(ls) return ls;
      }catch(e){}
      return deriveNameFromUI();
    }

    function ensureUid(){
      try{
        if(!window.uid && window.firebase && firebase.auth){
          const u = (firebase.auth().currentUser||{}).uid;
          if(u){ window.uid=u; localStorage.setItem('cupadoo_uid', u); }
        }
        if(!window.uid){
          const u2 = localStorage.getItem('cupadoo_uid');
          if(u2){ window.uid=u2; }
        }
      }catch(e){}
    }

    // Override isMyTurn again to use improved name extraction
    window.isMyTurn = function(){
      try{
        ensureUid();
        const s = window.state || {};
        const ps = Array.isArray(s.players) ? s.players : [];
        const cur = ps && ps[s.turnIndex];
        if(!cur || s.reveal || s.gameOver) return false;

        const myName = getStoredName();
        const meById   = ps.find(p=> p && p.id   === window.uid);
        const meByName = ps.find(p=> p && p.name === myName);

        const sameId   = !!(cur && meById   && cur.id   && cur.id   === meById.id);
        const sameName = !!(cur && meByName && cur.name && cur.name === meByName.name);

        return sameId || sameName;
      }catch(e){ return false; }
    };
  }catch(e){}
})();
</script>


<!-- v29: menu-safe periodic '(You)' capture + robust isMyTurn + helper -->
<script>
(function(){
  try{
    if(window.__v29Injected) return; window.__v29Injected = true;

    function saveName(val){
      if(!val) return;
      try{ localStorage.setItem('cupadoo_name', val); }catch(e){}
    }

    // Periodically scan the Players block for "Name (You)" and persist
    function captureYouName(){
      try{
        let best='', bestLen=1e9;
        const nodes = document.querySelectorAll('#players, .players, [data-role="players"], body *');
        nodes.forEach(n=>{
          const t=(n.textContent||'').replace(/\s+/g,' ').trim();
          if(!t) return;
          const m=t.match(/([A-Za-z0-9 _.-]{1,24})\s*\(You\)/i);
          if(m && m[1]){
            const cand=m[1].trim().replace(/[:¬∑‚Ä¢-]+$/,'').trim();
            if(cand && cand.length<bestLen){ best=cand; bestLen=cand.length; }
          }
        });
        if(best){ saveName(best); }
      }catch(e){}
    }
    // Run often at first, then slow down
    let count=0;
    const id=setInterval(()=>{
      captureYouName();
      count++;
      if(count>40){ clearInterval(id); setInterval(captureYouName, 2000); }
    }, 400);

    // Helper you can call from console if needed: setMyName('Josie')
    window.setMyName = function(n){ saveName(String(n||'').trim()); return localStorage.getItem('cupadoo_name'); };

    // Robust isMyTurn using uid OR stored name
    window.isMyTurn = function(){
      try{
        const s = window.state || {};
        const ps = Array.isArray(s.players) ? s.players : [];
        const cur = ps && ps[s.turnIndex];
        if(!cur || s.reveal || s.gameOver) return false;

        const stored = localStorage.getItem('cupadoo_name') || '';
        const meById   = ps.find(p=> p && p.id   === window.uid);
        const meByName = ps.find(p=> p && p.name === stored);

        const sameId   = !!(cur && meById   && cur.id   && cur.id   === meById.id);
        const sameName = !!(cur && meByName && cur.name && cur.name === meByName.name);

        return sameId || sameName;
      }catch(e){ return false; }
    };
  }catch(e){}
})();
</script>


<!-- v30: menu-safe sticky player name + safe '(You)' capture (no overwrite) -->
<script>
(function(){
  try{
    if(window.__v30Injected) return; window.__v30Injected = true;

    var PLACEHOLDERS = ['name', 'your name', 'player', 'player name', ''];
    function norm(s){ return String(s||'').trim(); }
    function isBadName(s){
      s = norm(s);
      if(!s) return true;
      var lower = s.toLowerCase();
      return PLACEHOLDERS.indexOf(lower) !== -1;
    }
    function saveName(val, lock){
      val = norm(val);
      if(!val || isBadName(val)) return;
      try{
        localStorage.setItem('cupadoo_name', val);
        if(lock) localStorage.setItem('cupadoo_name_locked','1');
      }catch(e){}
    }
    function getName(){
      try{ return norm(localStorage.getItem('cupadoo_name')); }catch(e){ return ''; }
    }
    function isLocked(){
      try{ return localStorage.getItem('cupadoo_name_locked') === '1'; }catch(e){ return false; }
    }
    // Expose helper: setMyName('Josie') will also lock to prevent overwrites
    window.setMyName = function(n){ saveName(n, true); return getName(); };

    // Lobby input persistence -> lock on a decent value
    (function persistLobbyName(){
      try{
        var el = document.getElementById('name');
        if(!el) return;
        var handler = function(){
          var v = norm(el.value);
          if(!isBadName(v)){ saveName(v, true); }
        };
        ['change','input','blur'].forEach(function(ev){ el.addEventListener(ev, handler, true); });
        handler(); // initial
      }catch(e){}
    })();

    // Improved '(You)' capture: only save if not locked and candidate looks real
    function captureYouName(){
      try{
        if(isLocked()) return;
        var best='', bestLen=1e9;
        var nodes = document.querySelectorAll('#players, .players, [data-role="players"], body *');
        for(var i=0;i<nodes.length;i++){
          var t = (nodes[i].textContent||'').replace(/\s+/g,' ').trim();
          if(!t) continue;
          var m = t.match(/([A-Za-z0-9 _.-]{2,24})\s*\(You\)/i); // min 2 chars to avoid "N"
          if(m && m[1]){
            var cand = norm(m[1]).replace(/[:¬∑‚Ä¢-]+$/,'').trim();
            if(!cand || isBadName(cand)) continue;
            if(cand.length < bestLen){ best = cand; bestLen = cand.length; }
          }
        }
        if(best && !isBadName(best)) saveName(best, false);
      }catch(e){}
    }

    // Poll quickly then slower; but never overwrite locked value
    var n=0, fastId=setInterval(function(){
      captureYouName();
      n++; if(n>40){ clearInterval(fastId); setInterval(captureYouName, 2000); }
    }, 400);

    // Robust isMyTurn (uid OR stored name)
    window.isMyTurn = function(){
      try{
        var s = window.state || {};
        var ps = Array.isArray(s.players)? s.players : [];
        var cur = ps && ps[s.turnIndex];
        if(!cur || s.reveal || s.gameOver) return false;
        var stored = getName();
        var meById   = ps.find(function(p){ return p && p.id === window.uid; });
        var meByName = ps.find(function(p){ return p && p.name === stored; });
        var sameId   = !!(cur && meById   && cur.id   && cur.id   === meById.id);
        var sameName = !!(cur && meByName && cur.name && cur.name === meByName.name);
        return sameId || sameName;
      }catch(e){ return false; }
    };
  }catch(e){}
})();
</script>


<!-- v31: HARD-LOCK name so scanners can't overwrite; ensure isMyTurn reads the locked value -->
<script>
(function(){
  try{
    if(window.__v31Injected) return; window.__v31Injected = true;

    // Utility
    function norm(s){ return String(s||'').trim(); }
    function isBadName(s){
      s = norm(s);
      if(!s) return true;
      var bad = ['name','your name','player','player name','anonymous','guest','null','undefined'];
      return bad.indexOf(s.toLowerCase()) !== -1;
    }

    // Monkey-patch localStorage.setItem to prevent overwriting a locked name
    (function hardenLocalStorage(){
      try{
        var _set = localStorage.setItem.bind(localStorage);
        localStorage.setItem = function(k,v){
          if(String(k) === 'cupadoo_name'){
            var locked = localStorage.getItem('cupadoo_name_locked') === '1';
            var lockVal = localStorage.getItem('cupadoo_name_lockValue') || '';
            var nv = norm(v);
            if(locked){
              // If locked, ignore attempts to set a different or bad value
              if(!nv || isBadName(nv) || (lockVal && nv !== lockVal)) return;
            }else{
              // If not locked yet, block obviously bad placeholders
              if(!nv || isBadName(nv)) return;
            }
          }
          return _set(k,v);
        };
      }catch(e){}
    })();

    function lockName(val){
      try{
        val = norm(val);
        if(!val || isBadName(val)) return false;
        localStorage.setItem('cupadoo_name', val);
        localStorage.setItem('cupadoo_name_locked','1');
        localStorage.setItem('cupadoo_name_lockValue', val);
        window.__nameLockedV31 = true;
        return true;
      }catch(e){ return false; }
    }
    function getName(){
      try{
        var v = norm(localStorage.getItem('cupadoo_name'));
        return v;
      }catch(e){ return ''; }
    }

    // Expose helper to set + lock
    window.setMyName = function(n){ return lockName(n); };

    // If lobby input exists and is valid, lock on first good value
    (function maybeLockFromLobby(){
      try{
        var el = document.getElementById('name');
        if(!el) return;
        var snap = norm(el.value);
        if(snap && !isBadName(snap)) lockName(snap);
        var handler = function(){
          var v = norm(el.value);
          if(v && !isBadName(v)) lockName(v);
        };
        ['change','blur'].forEach(function(ev){ el.addEventListener(ev, handler, true); });
      }catch(e){}
    })();

    // Re-define isMyTurn to use locked/stored name if uid missing
    window.isMyTurn = function(){
      try{
        var s = window.state || {};
        var ps = Array.isArray(s.players) ? s.players : [];
        var cur = ps && ps[s.turnIndex];
        if(!cur || s.reveal || s.gameOver) return false;

        var stored = getName();
        var meById   = ps.find(function(p){ return p && p.id === window.uid; });
        var meByName = ps.find(function(p){ return p && p.name === stored; });

        var sameId   = !!(cur && meById   && cur.id   && cur.id   === meById.id);
        var sameName = !!(cur && meByName && cur.name && cur.name === meByName.name);

        return sameId || sameName;
      }catch(e){ return false; }
    };
  }catch(e){}
})();
</script>


<!-- v32: force stored name to locked value; never use "Name" once locked -->
<script>
(function(){
  try{
    if(window.__v32Injected) return; window.__v32Injected = true;

    function norm(s){ return String(s||'').trim(); }
    function isBadName(s){
      s = norm(s);
      if(!s) return true;
      var bad = ['name','your name','player','player name','anonymous','guest','null','undefined'];
      return bad.indexOf(s.toLowerCase()) !== -1;
    }

    // Wrap localStorage.getItem so reads of cupadoo_name return the lock value when locked
    (function wrapGetSet(){
      try{
        var _get = localStorage.getItem.bind(localStorage);
        var _set = localStorage.setItem.bind(localStorage);

        localStorage.getItem = function(k){
          var v = _get(k);
          if(String(k) === 'cupadoo_name'){
            var locked = _get('cupadoo_name_locked') === '1';
            var lockVal = _get('cupadoo_name_lockValue') || '';
            if(locked && lockVal){ return lockVal; } // always coerce to locked value
            if(isBadName(v)) return ''; // ignore bad placeholders
          }
          return v;
        };

        localStorage.setItem = function(k,v){
          if(String(k) === 'cupadoo_name'){
            var locked = _get('cupadoo_name_locked') === '1';
            var lockVal = _get('cupadoo_name_lockValue') || '';
            var nv = norm(v);
            if(locked){
              // If locked, only allow writes that match the lock value
              if(!nv || isBadName(nv) || (lockVal && nv !== lockVal)) return;
            }else{
              if(!nv || isBadName(nv)) return;
            }
          }
          return _set(k,v);
        };
      }catch(e){}
    })();

    // Helper to hard lock name (also sets current name immediately)
    window.setMyName = function(n){
      try{
        var val = norm(n);
        if(!val || isBadName(val)) return false;
        localStorage.setItem('cupadoo_name', val);
        localStorage.setItem('cupadoo_name_locked','1');
        localStorage.setItem('cupadoo_name_lockValue', val);
        return true;
      }catch(e){ return false; }
    };

    // Ensure current stored name equals lockVal on load if locked
    (function syncStoredToLock(){
      try{
        var locked = localStorage.getItem('cupadoo_name_locked') === '1';
        var lockVal = localStorage.getItem('cupadoo_name_lockValue') || '';
        if(locked && lockVal){
          localStorage.setItem('cupadoo_name', lockVal);
        }
      }catch(e){}
    })();

    // Re-define isMyTurn unchanged (reads stored via getItem -> coerced to lock when locked)
    window.isMyTurn = function(){
      try{
        var s = window.state || {};
        var ps = Array.isArray(s.players) ? s.players : [];
        var cur = ps && ps[s.turnIndex];
        if(!cur || s.reveal || s.gameOver) return false;

        var stored = localStorage.getItem('cupadoo_name') || '';
        var meById   = ps.find(function(p){ return p && p.id === window.uid; });
        var meByName = ps.find(function(p){ return p && p.name === stored; });

        var sameId   = !!(cur && meById   && cur.id   && cur.id   === meById.id);
        var sameName = !!(cur && meByName && cur.name && cur.name === meByName.name);

        return sameId || sameName;
      }catch(e){ return false; }
    };
  }catch(e){}
})();
</script>


<!-- v33: Auto-repair cupadoo_name to lockVal whenever locked -->
<script>
(function(){
  try{
    if(window.__v33Injected) return; window.__v33Injected = true;
    function repairNameOnce(){
      try{
        var locked  = localStorage.getItem('cupadoo_name_locked') === '1';
        var lockVal = localStorage.getItem('cupadoo_name_lockValue') || '';
        var cur     = localStorage.getItem('cupadoo_name') || '';
        if(locked && lockVal && cur !== lockVal){
          localStorage.setItem('cupadoo_name', lockVal);
        }
      }catch(e){}
    }
    // run now and keep repairing regularly
    repairNameOnce();
    setInterval(repairNameOnce, 300);
    // also when tab becomes active
    document.addEventListener('visibilitychange', function(){
      if(!document.hidden) repairNameOnce();
    }, true);
  }catch(e){}
})();
</script>


<!-- v34: relaxed/robust isMyTurn (uid OR normalized name); no UI/layout changes -->
<script>
(function(){
  try{
    if(window.__v34Injected) return; window.__v34Injected = true;

    function normName(s){
      s = (s==null ? '' : String(s)).trim();
      // remove any ' (You)' suffix and repeated spaces, lower-case
      s = s.replace(/\(You\)\s*$/i, '').replace(/\s+/g,' ').trim();
      return s.toLowerCase();
    }

    function deriveNameFromUI(){
      // fallback: try to read "Name (You)" from players list
      try{
        var best='', bestLen=1e9;
        var nodes = document.querySelectorAll('#players, .players, [data-role="players"], body *');
        for(var i=0;i<nodes.length;i++){
          var t=(nodes[i].textContent||'').replace(/\s+/g,' ').trim();
          var m=t.match(/([A-Za-z0-9 _.-]{2,24})\s*\(You\)/i);
          if(m && m[1]){
            var cand = m[1].trim();
            if(cand && cand.length<bestLen){ best=cand; bestLen=cand.length; }
          }
        }
        return best;
      }catch(e){ return ''; }
    }

    // Override isMyTurn with relaxed logic
    window.isMyTurn = function(){
      try{
        var s = window.state || {};
        var ps = Array.isArray(s.players) ? s.players : [];
        var cur = ps && ps[s.turnIndex];
        if(!cur || s.reveal || s.gameOver) return false;

        // Gather identities
        var uid = window.uid;
        var stored = localStorage.getItem('cupadoo_name') || '';
        if(!stored){ stored = deriveNameFromUI(); }

        // Normalize for comparison
        var curNameN = normName(cur && cur.name);
        var myNameN  = normName(stored);

        // Try match by id
        var meById   = ps.find(function(p){ return p && p.id === uid; });
        var sameId   = !!(cur && meById && cur.id && (cur.id === meById.id));

        // Try match by normalized name
        var sameName = !!(curNameN && myNameN && (curNameN === myNameN));

        return sameId || sameName;
      }catch(e){
        return false;
      }
    };
  }catch(e){}
})();
</script>


<!-- v35: force-enable Bid/Dudo/Calza UI when isMyTurn() is true -->
<script>
(function(){
  try{
    if(window.__v35Injected) return; window.__v35Injected = true;

    function qButtons(){
      const all = Array.from(document.querySelectorAll('button, .btn'));
      const byText = (label) => all.filter(b => (b.textContent||'').trim().toLowerCase() === label);
      // normalize labels
      const t = s => s.replace(/\s+/g,' ').trim().toLowerCase();
      const match = (needle) => all.filter(b => t(b.textContent||'') === t(needle));
      // try multiple variants
      const bid  = (match('Make Bid')[0]   || match('Bid')[0]) || null;
      const dudo = (match('Dudo')[0]       || null);
      const calza= (match('Calza (Exact)')[0] || match('Calza')[0]) || null;
      return {bid, dudo, calza};
    }

    function enableBtn(el, yes){
      if(!el) return;
      try{
        if(yes){
          el.removeAttribute('disabled');
          el.style.pointerEvents = 'auto';
          el.style.opacity = '';
          el.classList.remove('disabled','btn-disabled','opacity-50','pointer-events-none');
        }else{
          el.setAttribute('disabled','');
          el.style.pointerEvents = 'none';
          el.style.opacity = '0.6';
          el.classList.add('disabled');
        }
      }catch(e){}
    }

    function turnTick(){
      try{
        const canAct = (typeof isMyTurn==='function') ? !!isMyTurn() : false;
        const {bid, dudo, calza} = qButtons();
        enableBtn(bid,  canAct);
        enableBtn(dudo, canAct);
        // Calza may be disallowed in Palifico; only enable if !palifico
        let allowCalza = canAct;
        try{
          const s = window.state || {};
          if(s && s.palifico) allowCalza = false;
        }catch(e){}
        enableBtn(calza, allowCalza);

        // Also hide any blocking tooltip/toast element that sits over the buttons
        const blockers = Array.from(document.querySelectorAll('[role="tooltip"], .toast, .snackbar'))
          .filter(n => /turn/i.test(n.textContent||''));
        blockers.forEach(n => { n.style.display = 'none'; n.style.pointerEvents='none'; });
      }catch(e){}
    }

    // Run frequently to keep in sync
    setInterval(turnTick, 150);
    document.addEventListener('visibilitychange', () => { if(!document.hidden) turnTick(); }, true);
    window.addEventListener('statechange', turnTick, true);
    setTimeout(turnTick, 50);
  }catch(e){}
})();
</script>


<!-- v36: if isMyTurn() matches by name but window.uid is missing, hydrate uid with the matching player's id -->
<script>
(function(){
  try{
    if(window.__v36Injected) return; window.__v36Injected = true;

    function normName(s){
      s = (s==null ? '' : String(s)).trim();
      s = s.replace(/\(You\)\s*$/i, '').replace(/\s+/g,' ').trim();
      return s.toLowerCase();
    }

    // Wrap existing isMyTurn to also hydrate window.uid when we can infer it
    var oldIsMyTurn = (typeof window.isMyTurn === 'function') ? window.isMyTurn : function(){ return false; };

    window.isMyTurn = function(){
      try{
        var s = window.state || {};
        var ps = Array.isArray(s.players) ? s.players : [];
        var cur = ps && ps[s.turnIndex];
        if(!cur || s.reveal || s.gameOver) return false;

        var result = oldIsMyTurn(); // uses relaxed logic from v34

        // If not revealed/gameover and we appear to be the current player by name,
        // but window.uid is missing, set it so internal guards pass.
        try{
          var stored = localStorage.getItem('cupadoo_name') || '';
          var myN = normName(stored);
          var meByName = ps.find(function(p){ return p && normName(p.name) === myN; });
          if(meByName && meByName.id && (!window.uid || typeof window.uid !== 'string')){
            window.uid = meByName.id;
            // dispatch a light event so any listeners can refresh
            window.dispatchEvent(new Event('statechange'));
          }
        }catch(e){}

        return !!result;
      }catch(e){
        return false;
      }
    };
  }catch(e){}
})();
</script>


<!-- v37: ensure bid button is clickable; kill overlays; re-dispatch submit if original handler doesn't fire -->
<script>
(function(){
  try{
    if(window.__v37Injected) return; window.__v37Injected = true;

    function textOf(el){ return (el && el.textContent || '').replace(/\s+/g,' ').trim().toLowerCase(); }
    function findButton(){
      const all = Array.from(document.querySelectorAll('button,.btn'));
      return all.find(b => /^(make\s+bid|bid)$/i.test((b.textContent||'').trim()));
    }
    function findInputs(){
      // try to locate quantity and face inputs near the buttons
      const inputs = Array.from(document.querySelectorAll('input,select'));
      let qty=null, face=null;
      inputs.forEach(i=>{
        const ph = (i.getAttribute('placeholder')||'').toLowerCase();
        const name = (i.getAttribute('name')||'').toLowerCase();
        const aria = (i.getAttribute('aria-label')||'').toLowerCase();
        const t = ph + ' ' + name + ' ' + aria;
        if(!qty && /(qty|quantity)/.test(t)) qty = i;
        if(!face && /(face|value|pips?)/.test(t)) face = i;
      });
      // fallback: choose two numeric inputs
      if(!qty || !face){
        const nums = inputs.filter(i=>/^(number|tel|text)$/.test(i.type||'text'));
        if(nums.length>=2){ qty = qty||nums[0]; face = face||nums[1]; }
      }
      return {qty, face};
    }

    function killOverlaysOver(el){
      if(!el) return;
      const r = el.getBoundingClientRect();
      const pts = [
        [r.x+r.width/2, r.y+r.height/2],
        [r.x+5, r.y+5],
        [r.right-5, r.bottom-5]
      ];
      pts.forEach(([x,y])=>{
        const top = document.elementFromPoint(x,y);
        if(top && top!==el && top!==document.body){
          // hide likely overlay/toast/backdrop
          const txt = (top.textContent||'').toLowerCase();
          if(/turn|toast|snack|overlay|backdrop|modal|block/i.test(top.className+ ' ' + top.id + ' ' + txt)){
            top.style.pointerEvents='none';
            top.style.display='none';
          }
        }
      });
    }

    function tryNativeClick(btn){
      if(!btn) return false;
      try{
        btn.removeAttribute('disabled');
        btn.style.pointerEvents = 'auto';
        btn.style.opacity = '';
        ['disabled','btn-disabled','opacity-50','pointer-events-none'].forEach(c=>btn.classList.remove(c));
        killOverlaysOver(btn);
        btn.click();
        return true;
      }catch(e){ return false; }
    }

    function fallbackDispatch(){
      try{
        const {qty, face} = findInputs();
        const qv = qty ? parseInt(qty.value,10) : NaN;
        const fv = face ? parseInt(face.value,10) : NaN;
        const payload = {type:'bid', qty:qv, face: fv};
        // Try common app hooks
        const hooks = ['submitBid','makeBid','onBid','doBid','bid'];
        for(const h of hooks){
          if(typeof window[h]==='function'){
            try{ window[h](qv,fv); return 'called '+h; }catch(e){}
            try{ window[h](payload); return 'called '+h; }catch(e){}
          }
        }
        // Try to submit nearest form
        const btn = findButton();
        const form = btn && btn.closest('form');
        if(form){
          const ev = new Event('submit', {bubbles:true,cancelable:true});
          form.dispatchEvent(ev);
          if(typeof form.submit==='function'){ form.submit(); }
          return 'submitted form';
        }
        // Try firing custom event
        const ev2 = new CustomEvent('cupadoo:bid',{detail:payload,bubbles:true});
        (btn||document).dispatchEvent(ev2);
        return 'dispatched custom event';
      }catch(e){ return 'fallback error'; }
    }

    function ensureBidWorks(){
      const s = window.state || {};
      const canAct = (typeof window.isMyTurn==='function') ? window.isMyTurn() : false;
      if(!canAct || s.reveal || s.gameOver) return;

      const btn = findButton();
      if(!btn) return;

      // tap handler once to ensure it fires; if state doesn't change shortly, fallback
      const before = JSON.stringify({ti:(s.turnIndex), last:(s.lastAction||null)});
      let clicked = tryNativeClick(btn);
      setTimeout(function(){
        const s2 = window.state || {};
        const after = JSON.stringify({ti:(s2.turnIndex), last:(s2.lastAction||null)});
        if(before === after){
          // no change -> fallback
          const res = fallbackDispatch();
          console.debug('[v37 bid fallback]', res);
        }
      }, 250);
    }

    // Bind our helper to Make Bid button clicks (capture) to ensure we run
    document.addEventListener('click', function(ev){
      const target = ev.target;
      if(!target) return;
      const label = (target.textContent||'').trim().toLowerCase();
      if(label === 'make bid' || label === 'bid'){
        // let app handler run, then we check/repair after a tick
        setTimeout(ensureBidWorks, 100);
      }
    }, true);

    // Also add a keyboard shortcut for testing: press 'b' to force ensure
    document.addEventListener('keydown', function(e){
      if((e.key||'').toLowerCase()==='b') ensureBidWorks();
    }, false);
  }catch(e){}
})();
</script>


<!-- v38: discover real bid handler heuristically and call it -->
<script>
(function(){
  try{
    if(window.__v38Injected) return; window.__v38Injected = true;

    function findButton(){
      const all = Array.from(document.querySelectorAll('button,.btn'));
      return all.find(b => /^(make\s+bid|bid)$/i.test((b.textContent||'').trim()));
    }

    function normSrc(fn){
      try{ return (Function.prototype.toString.call(fn) || '').toLowerCase(); }
      catch(e){ return ''; }
    }

    function collectGlobals(){
      const res = [];
      for (const k in window){
        try{
          const v = window[k];
          if(typeof v === 'function'){
            const src = normSrc(v);
            if(/bid|makebid|submit.*bid|dudo|calza|face|qty|quantity/.test(src)){
              res.push({name:k, fn:v, src});
            }
          }else if(v && typeof v === 'object'){
            // shallow scan object properties
            const keys = Object.keys(v).slice(0,50);
            keys.forEach(kk=>{
              try{
                const vv = v[kk];
                if(typeof vv === 'function'){
                  const src = normSrc(vv);
                  if(/bid|makebid|submit.*bid|dudo|calza|face|qty|quantity/.test(src)){
                    res.push({name:k+'.'+kk, fn:vv, src});
                  }
                }
              }catch(e){}
            });
          }
        }catch(e){}
      }
      return res;
    }

    function tryCallHandlers(q, f){
      const hits = collectGlobals();
      console.debug('[v38] handler candidates', hits.map(h=>h.name));
      for(const h of hits){
        try{
          // Try (qty, face)
          if(h.fn.length >= 2){ h.fn(q,f); return 'called '+h.name+'(q,f)'; }
          // Try (payload)
          h.fn({type:'bid', qty:q, face:f});
          return 'called '+h.name+'({payload})';
        }catch(e){}
      }
      return 'no handler called';
    }

    // hook Make Bid button after click and call heuristic if state unchanged
    document.addEventListener('click', function(ev){
      const t = ev.target;
      if(!t) return;
      const label = (t.textContent||'').trim().toLowerCase();
      if(label === 'make bid' || label === 'bid'){
        setTimeout(function(){
          try{
            const s = window.state || {};
            const before = JSON.stringify({ti:(s.turnIndex), last:(s.lastAction||null)});
            setTimeout(function(){
              const s2 = window.state || {};
              const after = JSON.stringify({ti:(s2.turnIndex), last:(s2.lastAction||null)});
              if(before === after){
                const inputs = Array.from(document.querySelectorAll('input,select'));
                let q=null,f=null;
                inputs.forEach(i=>{
                  const txt = ((i.getAttribute('name')||'')+' '+(i.getAttribute('aria-label')||'')+' '+(i.placeholder||'')).toLowerCase();
                  if(/qty|quantity/.test(txt) && q==null) q = parseInt(i.value,10);
                  if(/face|value|pips?/.test(txt) && f==null) f = parseInt(i.value,10);
                });
                if(q==null||isNaN(q)){ q = parseInt((inputs.find(i=>/\d/.test(i.value))||{}).value||''); }
                if(f==null||isNaN(f)){ f = parseInt((inputs.reverse().find(i=>/\d/.test(i.value))||{}).value||''); }
                const res = tryCallHandlers(q,f);
                console.debug('[v38] '+res);
              }
            }, 250);
          }catch(e){}
        }, 50);
      }
    }, true);
  }catch(e){}
})();
</script>


<!-- v39: broaden search & auto-call more handler patterns; log everything -->
<script>
(function(){
  try{
    if(window.__v39Injected) return; window.__v39Injected = true;
    console.debug('[v39] loaded handler hunt');

    function findButton(){
      const all = Array.from(document.querySelectorAll('button,.btn'));
      return all.find(b => /^(make\s+bid|bid)$/i.test((b.textContent||'').trim()));
    }

    function getInputs(){
      const inputs = Array.from(document.querySelectorAll('input,select'));
      let q=null,f=null;
      inputs.forEach(i=>{
        const txt = ((i.getAttribute('name')||'')+' '+(i.getAttribute('aria-label')||'')+' '+(i.placeholder||'')).toLowerCase();
        if(/qty|quantity/.test(txt) && q==null) q = parseInt(i.value,10);
        if(/face|value|pips?/.test(txt) && f==null) f = parseInt(i.value,10);
      });
      // fallback to first two numeric-like
      const nums = inputs.filter(i=>/\d/.test(i.value||''));
      if(q==null && nums[0]) q = parseInt(nums[0].value,10);
      if(f==null && nums[1]) f = parseInt(nums[1].value,10);
      return {q:isNaN(q)?null:q, f:isNaN(f)?null:f};
    }

    function normSrc(fn){
      try{ return (Function.prototype.toString.call(fn) || '').toLowerCase(); }
      catch(e){ return ''; }
    }

    function pushCandidate(list, name, obj, key){
      try{
        const fn = obj[key];
        if(typeof fn !== 'function') return;
        const src = normSrc(fn);
        const nameOk = /bid|makebid|submit.*bid/.test(name.toLowerCase());
        const srcOk  = /bid|quantity|face|firebase|update|push/.test(src);
        if(nameOk || srcOk){
          list.push({name, fn, src});
        }
      }catch(e){}
    }

    function collectCandidates(){
      const out = [];
      // window level
      for(const k in window){
        try{
          pushCandidate(out, k, window, k);
          const v = window[k];
          if(v && typeof v === 'object'){
            const keys = Object.keys(v).slice(0,200);
            for(const kk of keys){
              pushCandidate(out, k+'.'+kk, v, kk);
            }
          }
        }catch(e){}
      }
      return out;
    }

    function callCandidates(q,f){
      const cands = collectCandidates();
      console.debug('[v39] candidates:', cands.map(c=>c.name).slice(0,50));
      const payload = {type:'bid', qty:q, face:f};
      // Prefer names with "bid" in them
      const sorted = cands.sort((a,b)=>{
        const aw = /bid/.test(a.name.toLowerCase()) ? -1 : 0;
        const bw = /bid/.test(b.name.toLowerCase()) ? -1 : 0;
        return aw - bw;
      });
      for(const c of sorted){
        try{
          if(c.fn.length >= 2){ c.fn(q,f); console.debug('[v39] called', c.name, '(q,f)'); return 'called '+c.name+'(q,f)'; }
          c.fn(payload); console.debug('[v39] called', c.name, '({payload})'); return 'called '+c.name+'({payload})';
        }catch(e){ /* try next */ }
      }
      // Try dispatching a generic CustomEvent again (maybe the app listens globally)
      const ev2 = new CustomEvent('cupadoo:bid',{detail:payload,bubbles:true});
      (findButton()||document).dispatchEvent(ev2);
      console.debug('[v39] dispatched custom event');
      return 'dispatched custom event';
    }

    // After Make Bid click, if state unchanged, trigger callCandidates
    document.addEventListener('click', function(ev){
      const t = ev.target;
      if(!t) return;
      const label = (t.textContent||'').trim().toLowerCase();
      if(label==='make bid' || label==='bid'){
        setTimeout(function(){
          try{
            const s = window.state || {};
            const before = JSON.stringify({ti:(s.turnIndex), last:(s.lastAction||null)});
            setTimeout(function(){
              const s2 = window.state || {};
              const after = JSON.stringify({ti:(s2.turnIndex), last:(s2.lastAction||null)});
              if(before === after){
                const {q,f} = getInputs();
                const res = callCandidates(q,f);
                console.debug('[v39] result', res);
              }
            }, 250);
          }catch(e){}
        }, 50);
      }
    }, true);

    // Debug helper to call manually
    window.__bidNow = function(q,f){
      const vals = getInputs();
      return callCandidates(q==null?vals.q:q, f==null?vals.f:f);
    };
  }catch(e){}
})();
</script>


<!-- v40: Hardened isMyTurn to avoid stale uid/name and rely on UI '(You)' tag as fallback -->
<script>
(function(){
  try{
    // Preserve original for debugging
    window.__origIsMyTurn = window.isMyTurn || null;

    window.isMyTurn = function(){
      try{
        var s  = window.state || {};
        var ps = Array.isArray(s.players) ? s.players : [];
        var cur = ps[s.turnIndex];
        if(!cur || s.reveal || s.gameOver) return false;

        var stored = localStorage.getItem('cupadoo_name') || '';
        var uid    = window.uid;

        var meById   = ps.find(function(p){ return p && p.id   === uid; });
        var meByName = ps.find(function(p){ return p && p.name === stored; });

        var sameId   = !!(cur && meById   && cur.id   === meById.id);
        var sameName = !!(cur && meByName && cur.name === meByName.name);

        if (sameId || sameName) return true;

        // FINAL UI fallback: read the "(You)" label currently highlighted
        var youChip = document.querySelector('.player.you .player-left') 
                   || document.querySelector('.you, .player-you');
        var uiNameText = '';
        if (youChip){
          uiNameText = (youChip.textContent || '').trim();
          var idx = uiNameText.indexOf('(You');
          if (idx > 0) uiNameText = uiNameText.slice(0, idx).trim();
        }

        if (uiNameText && cur.name && uiNameText.toLowerCase() === cur.name.toLowerCase()) {
          return true;
        }

        return false;
      } catch(e){ 
        return false; 
      }
    };

    // Also expose a quick debug helper
    window.debugTurn = function(){
      var s  = window.state || {};
      var ps = Array.isArray(s.players) ? s.players : [];
      var cur = ps[s.turnIndex];
      var stored = localStorage.getItem('cupadoo_name') || '';
      var uid = window.uid;
      var meById   = ps.find(function(p){ return p && p.id   === uid; });
      var meByName = ps.find(function(p){ return p && p.name === stored; });
      var youChip = document.querySelector('.player.you .player-left') 
                 || document.querySelector('.you, .player-you');
      var uiNameText = '';
      if (youChip){
        uiNameText = (youChip.textContent || '').trim();
        var idx = uiNameText.indexOf('(You');
        if (idx > 0) uiNameText = uiNameText.slice(0, idx).trim();
      }
      return {
        round: s.round, turnIndex: s.turnIndex, palifico: s.palifico,
        reveal: s.reveal, gameOver: s.gameOver,
        uid: uid, storedName: stored,
        cur: cur,
        meById: meById, meByName: meByName,
        uiNameText: uiNameText,
        isMyTurn_now: (typeof window.isMyTurn==='function') ? window.isMyTurn() : null
      };
    };
    console.debug('[v40] isMyTurn hardened loaded');
  }catch(e){}
})();
</script>


<!-- v41: Global crash guards to prevent white screen on Josie's Round 2 -->
<script>
(function(){
  // Lightweight toast
  function toast(msg){
    try{
      var t = document.createElement('div');
      t.textContent = msg;
      t.style.cssText = 'position:fixed;left:50%;transform:translateX(-50%);bottom:18px;padding:10px 14px;background:#111a;border-radius:10px;color:#fff;font:600 14px system-ui,Segoe UI,Roboto;z-index:2147483647;box-shadow:0 6px 20px rgba(0,0,0,.35)';
      document.body.appendChild(t);
      setTimeout(()=>{ t.remove(); }, 2600);
    }catch(e){}
  }

  // Global error hooks
  window.addEventListener('error', function(e){
    console.error('[v41 error]', e.message, e.filename, e.lineno, e.colno, e.error);
    toast('Recovered from an error ‚Äî check console (v41)');
  });
  window.addEventListener('unhandledrejection', function(e){
    console.error('[v41 unhandledrejection]', e.reason);
    toast('Recovered from a promise error ‚Äî check console (v41)');
  });

  // Wrap requestAnimationFrame callbacks defensively
  (function(){
    var raf = window.requestAnimationFrame;
    if(typeof raf === 'function'){
      window.requestAnimationFrame = function(cb){
        if(typeof cb !== 'function') return raf(cb);
        return raf(function(ts){
          try{ cb(ts); } catch(err){
            console.error('[v41 RAF guard]', err);
            toast('Render recovered (v41)');
          }
        });
      };
    }
  })();

  // Watchdog: if body is blank (white screen), reload gracefully
  setInterval(function(){
    try{
      var hasUI = document.body && document.body.children && document.body.children.length > 0;
      var bg = getComputedStyle(document.body||document.documentElement).backgroundColor || '';
      if(!hasUI){
        console.warn('[v41 watchdog] empty body ‚Äî reloading');
        location.reload();
      }
    }catch(e){ /* ignore */ }
  }, 3000);
})();
</script>

</body>
</html>
