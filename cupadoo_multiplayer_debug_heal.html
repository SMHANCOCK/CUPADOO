<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CUPADOO! — Multiplayer (DEBUG • HB Fix + Self-Heal)</title>
  <style>
    :root { --bg:#0b1020; --ink:#e5e7eb; --card:#111827; --accent:#22c55e; --muted:#94a3b8; --warn:#f59e0b; --err:#ef4444; }
    body { margin:0; font-family:system-ui, sans-serif; background:var(--bg); color:var(--ink); }
    .wrap { max-width:820px; margin:24px auto; padding:16px; }
    .pill { font-size:12px; padding:2px 8px; border-radius:999px; background:#0b1220; color:#cbd5e1 }
    .card { background:#111827; padding:16px; border-radius:12px; }
    .kv { display:grid; grid-template-columns:200px 1fr; gap:8px; font-family:ui-monospace,monospace; }
    .kv div { padding:4px 0; border-bottom:1px dashed #263044 }
    input, button { border-radius:10px; border:none; font-size:16px; }
    input { width:100%; margin:8px 0; padding:12px 14px; font-size:18px; background:#0b1220; color:#fff; border:2px solid #1f2937; }
    button { cursor:pointer; margin:8px 0; padding:12px 14px; background:var(--accent); color:#05170c; font-weight:700; }
    button.secondary { background:#1f2937; color:#fff; }
    button.warn { background:var(--warn); color:#1f1305 }
    .hidden { display:none }
    .players { margin-top:12px }
    .player { background:#101523; padding:8px 10px; border-radius:10px; margin:4px 0; display:flex; justify-content:space-between; }
    .small { font-size:12px; color:#94a3b8 }
    textarea.log { width:100%; height:220px; background:#020617; color:#e2e8f0; border:1px solid #1f2937; border-radius:8px; padding:8px; resize:vertical; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>CUPADOO! 🎲 Multiplayer <span class="pill">HB Fix + Self-Heal</span></h1>
    <div class="card">
      <div class="kv" id="kv">
        <div>version</div><div id="kv-ver">2025-08-17-HEAL-1</div>
        <div>dbURL</div><div id="kv-dburl">—</div>
        <div>playerId</div><div id="kv-playerId">—</div>
        <div>playerName</div><div id="kv-playerName">—</div>
        <div>isHost</div><div id="kv-isHost">—</div>
        <div>roomCode</div><div id="kv-roomCode">—</div>
        <div>playersRef path</div><div id="kv-ppath">—</div>
        <div>lastError</div><div id="kv-lastError" style="color:#ef4444">—</div>
      </div>
    </div>

    <div id="screen-setup" class="card">
      <button id="btnCreate">Create Room</button>
      <button id="btnPing" class="secondary">Test Write</button>
      <input id="joinCode" placeholder="Enter room code" />
      <button id="btnJoin">Join Room</button>
    </div>

    <div id="screen-wait" class="card hidden">
      <h2>Room Code: <span id="roomCodeLbl"></span></h2>
      <button id="btnCopy" class="secondary">Copy Code</button>
      <button id="btnLeave" class="warn">Leave Room</button>
      <h3>Players</h3>
      <div id="playersList" class="players"></div>
    </div>

    <details class="card" open>
      <summary><strong>Debug Console</strong></summary>
      <textarea id="debugLog" class="log" spellcheck="false" readonly></textarea>
    </details>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script>
    const $ = (id) => document.getElementById(id);
    const dbgEl = $("debugLog");
    const setKV = (k,v) => { const el = document.getElementById("kv-"+k); if (el) el.textContent = v; };
    const dbg = (...args) => {
      const line = args.map(a => { try { return typeof a === "object" ? JSON.stringify(a) : String(a); } catch { return String(a); } }).join(" ");
      dbgEl.value += `[${new Date().toISOString()}] ${line}\n`;
      dbgEl.scrollTop = dbgEl.scrollHeight;
      console.log(...args);
    };
    const setErr = (msg) => { setKV("lastError", msg); dbg("❌", msg); };

    try { firebase.database.enableLogging(true); } catch(e) {}

    const firebaseConfig = {
      apiKey: "AIzaSyA1iB1gMq2UubLhlUDvDdnQPOZ1l5utGW8",
      authDomain: "cupadoo-80273.firebaseapp.com",
      databaseURL: "https://cupadoo-80273-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "cupadoo-80273",
      storageBucket: "cupadoo-80273.firebasestorage.app",
      messagingSenderId: "827895807709",
      appId: "1:827895807709:web:806035be2f119d3993e534",
      measurementId: "G-8MHF4LZ9JR"
    };
    const app = firebase.apps?.length ? firebase.app() : firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    setKV("dburl", app.options?.databaseURL || "(none)");

    let roomCode = null;
    let playerId = "p" + Math.floor(Math.random()*999999);
    let playerName = "Player " + Math.floor(Math.random()*1000);
    let isHost = false;
    let playerRef, playersRef, roomRef;
    let hb;

    setKV("playerId", playerId);
    setKV("playerName", playerName);
    setKV("isHost", isHost);
    setKV("roomCode", "—");

    function generateCode(){ const c="ABCDEFGHJKLMNPQRSTUVWXYZ23456789"; return Array.from({length:4},()=>c[Math.floor(Math.random()*c.length)]).join(""); }

    function safeName(p){ return (p && typeof p.name === "string" && p.name.trim()) ? p.name : "(anon)"; }

    function renderPlayers(obj){
      const list = $("playersList"); list.innerHTML="";
      Object.entries(obj||{}).forEach(([id,p])=>{
        const row = document.createElement("div");
        row.className = "player";
        row.innerHTML = `<span>${safeName(p)}${p && p.host ? " <span class='pill'>Host</span>" : ""}</span><span class="small">${id}</span>`;
        list.appendChild(row);
      });
    }

    async function selfHealIfNeeded(players){
      const mine = players[playerId] || {};
      let toFix = {};
      if (!("name" in mine)) toFix.name = playerName;
      if (!("host" in mine)) toFix.host = isHost;
      if (!("ai" in mine)) toFix.ai = false;
      if (Object.keys(toFix).length){
        dbg("🩹 Self-heal: restoring missing fields on my player:", toFix);
        try { await playerRef.update(toFix); } catch(e){ setErr("Self-heal failed: " + e.message); }
      }
    }

    async function joinRoom(code){
      roomCode = code; setKV("roomCode", code); setKV("ppath", `rooms/${code}/players`);
      $("screen-setup").classList.add("hidden");
      $("screen-wait").classList.remove("hidden");
      $("roomCodeLbl").textContent = code;

      playerRef = db.ref(`rooms/${code}/players/${playerId}`);
      await playerRef.set({ name: playerName, host: isHost, ai:false, joinedAt: firebase.database.ServerValue.TIMESTAMP, lastSeen: firebase.database.ServerValue.TIMESTAMP });
      try { await playerRef.onDisconnect().remove(); dbg("✅ onDisconnect registered"); } catch(e){ setErr("onDisconnect failed: " + e.message); }

      if (hb) clearInterval(hb);
      hb = setInterval(()=> {
        playerRef.child("lastSeen").set(firebase.database.ServerValue.TIMESTAMP).catch(e=>setErr("HB failed: " + e.message));
      }, 10000);

      playersRef = db.ref(`rooms/${code}/players`);
      playersRef.on("value", snap=>{
        const val = snap.val() || {};
        renderPlayers(val);
        selfHealIfNeeded(val);
        dbg("👥 Players now:", val);
      });
    }

    $("btnCreate").onclick = async () => { isHost = true; setKV("isHost", isHost); await joinRoom(generateCode()); };
    $("btnJoin").onclick = async () => { const c=$("joinCode").value.trim().toUpperCase(); if(!c) return; isHost=false; setKV("isHost", isHost); await joinRoom(c); };
    $("btnPing").onclick = () => db.ref("__debug/ping").push({ t:Date.now(), ua:navigator.userAgent }).then(()=>dbg("✅ Test write ok")).catch(e=>setErr("Ping failed: "+e.message));
    $("btnCopy").onclick = async () => { try { await navigator.clipboard.writeText(roomCode); } catch(e){} };
    $("btnLeave").onclick = async () => {
      try{
        if(hb) clearInterval(hb);
        if(playersRef) playersRef.off();
        if(roomRef) roomRef.off();
        if(playerRef) await playerRef.remove();
      } finally {
        $("screen-setup").classList.remove("hidden");
        $("screen-wait").classList.add("hidden");
        roomCode=null; setKV("roomCode","—"); setKV("ppath","—"); isHost=false; setKV("isHost", isHost);
      }
    };
  </script>
</body>
</html>
