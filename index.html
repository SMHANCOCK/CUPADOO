<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1" />
<title>CUPADOO! ‚Äî Multiplayer (Firebase RTDB)</title>
<style>
:root { --bg:#0f172a; --panel:#0b1220; --card:#111827; --text:#e5e7eb; --muted:#94a3b8; --accent:#22c55e; --danger:#ef4444; --warn:#f59e0b; --table:#1e3a8a; --table2:#2563eb; }
*{ box-sizing:border-box; } body{ margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; }
.wrap{ max-width:980px; margin:0 auto; padding:16px; } .topbar{ position:relative; display:flex; align-items:flex-start; justify-content:space-between; gap:10px; margin-bottom:10px; }
.title{ display:flex; flex-direction:column; line-height:1; }
.brand{ font-weight:900; font-size:22px; letter-spacing:0.5px; font-family: 'Fredoka','Nunito','Poppins','system-ui',-apple-system,Segoe UI,Roboto,Helvetica,Arial; }
.brand .r{ color:#ff3b30; } .brand .y{ color:#ffd60a; } .brand .o{ color:#ff8c00; }
.slogan{ margin-top:4px; font-size:12px; color:var(--muted); font-weight:700; font-style:italic; }
.menu-btn{ padding:10px 12px; border-radius:12px; background:#0b1220; border:1px solid #1f2937; color:var(--text); font-weight:700; align-self:flex-start; }
.card{ background:var(--card); border-radius:18px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.35); }
h1{ margin:0 0 8px; font-size:24px; } h2{ margin:14px 0 8px; } .muted{ color:var(--muted); }
.row{ display:flex; gap:10px; } .row>*{ flex:1; }
button{ width:100%; padding:14px; border:none; border-radius:14px; font-weight:700; font-size:16px; background:linear-gradient(180deg,#22c55e,#16a34a); color:#05170c; cursor:pointer; }
button.secondary{ background:#1f2937; color:var(--text); }
button.warn{ background:linear-gradient(180deg,var(--warn),#eab308); color:#111; }
button.danger{ background:linear-gradient(180deg,var(--danger),#b91c1c); color:#fff; }
button.link{ background:#0b1220; color:var(--text); border:1px solid #1f2937; }
button[disabled]{ opacity:.45; cursor:not-allowed; }
input[type=number],input[type=text],select{ width:100%; padding:12px; border-radius:12px; border:1px solid #1f2937; background:var(--panel); color:var(--text); font-size:16px; }
.pill{ display:inline-block; padding:6px 10px; border-radius:999px; background:var(--panel); color:var(--muted); font-size:12px; }
.players{ display:grid; gap:10px; } .player{ display:flex; align-items:center; justify-content:space-between; background:#101523; border:1px solid #1f2937; padding:10px 12px; border-radius:14px; }
.player.you{ outline:2px solid var(--accent); } .turn{ border:1px dashed var(--accent); }
.player-left{ display:flex; align-items:center; gap:10px; } .player-right{ display:flex; align-items:center; gap:10px; }
.tag{ font-size:12px; color:var(--muted); }
.skull{ font-size:14px; filter:drop-shadow(0 1px 1px rgba(0,0,0,.4)); }
.dice{ display:flex; gap:8px; flex-wrap:wrap; justify-content:center; }
.die{ width:44px; height:44px; border-radius:12px; background:var(--panel); display:grid; place-items:center; font-weight:800; font-size:20px; border:1px solid #1f2937; }
.die.small{ width:22px; height:22px; font-size:13px; border-radius:6px; }
.die.reveal{ width:36px; height:36px; font-size:18px; transition:transform .35s ease, opacity .35s ease; }
.match{ box-shadow:0 0 0 2px var(--accent) inset, 0 0 10px rgba(34,197,94,.5); }
.fade-out .die.reveal{ transform:translateY(8px) scale(.9); opacity:0; }
.dudo-badge{ font-size:11px; padding:3px 7px; border-radius:999px; background:var(--danger); color:#fff; }
.hidden{ display:none !important; } .center{ text-align:center; } .big{ font-size:28px; font-weight:800; letter-spacing:1px; }
.toast{ position:fixed; bottom:16px; left:50%; transform:translateX(-50%); background:var(--panel); padding:12px 16px; border-radius:14px; border:1px solid #1f2937; z-index:999; }
.footer{ position:sticky; bottom:0; left:0; right:0; background:linear-gradient(180deg,transparent,rgba(0,0,0,.35)); padding-top:8px; }
.table-wrap{ display:grid; place-items:center; margin:12px 0 8px; }
.table{ width:100%; max-width:720px; aspect-ratio:1/1; border-radius:9999px; background:radial-gradient(75% 75% at 50% 30%, var(--table2), var(--table)); box-shadow:inset 0 8px 40px rgba(0,0,0,.45), 0 10px 30px rgba(0,0,0,.35); border:2px solid #0b3b8e; padding:18px; position:relative; overflow:visible; }
.seats{ position:absolute; inset:0; z-index:5; } .seat{ position:absolute; transform:translate(-50%,-50%); }
.seat-inner{ display:flex; align-items:center; gap:8px; background:rgba(0,0,0,0.28); padding:6px 8px; border-radius:12px; border:1px solid rgba(255,255,255,0.08); backdrop-filter:blur(2px); white-space:nowrap; }
.seat.turn .seat-inner{ box-shadow:0 0 0 2px var(--accent) inset, 0 0 14px rgba(34,197,94,0.45); }
.name{ font-weight:700; font-size:13px; } .last-text{ font-size:12px; color:var(--text); opacity:.95; }
.bid-center{ position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); text-align:center; z-index:1; }
.bid-center .big{ text-shadow:0 2px 8px rgba(0,0,0,.35); }
.overlay{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,.55); z-index:1000; }
.modal{ background:#0b1220; border:1px solid #1f2937; padding:20px; border-radius:18px; width:min(560px, 94vw); text-align:center; box-shadow:0 10px 40px rgba(0,0,0,.5); position:relative; overflow:hidden; }
.reveal-grid{ display:grid; grid-template-columns:1fr; gap:10px; text-align:left; }
.reveal-row{ display:flex; align-items:center; gap:10px; border:1px solid #1f2937; border-radius:12px; padding:8px; }
.reveal-name{ font-weight:700; min-width:110px; } .reveal-dice{ display:flex; flex-wrap:wrap; gap:6px; }
.count-line{ margin-top:8px; font-weight:800; font-size:18px; }
@keyframes overlayFadeOut{ from{opacity:1; transform:scale(1);} to{opacity:0; transform:scale(.98);} } .overlay.fade-out .modal{ animation:overlayFadeOut 1s ease forwards; }
@keyframes diceRollIn{ from{transform:translateY(-6px) rotate(-12deg); opacity:0;} to{transform:none; opacity:1;} }
.roll-in .die{ animation:diceRollIn 600ms ease both; }
.roll-in .die:nth-child(2){ animation-delay:.05s; } .roll-in .die:nth-child(3){ animation-delay:.1s; }
.roll-in .die:nth-child(4){ animation-delay:.15s; } .roll-in .die:nth-child(5){ animation-delay:.2s; }
.confetti-host{ position:absolute; inset:0; pointer-events:none; overflow:hidden; } .confetti{ position:absolute; width:8px; height:12px; opacity:0; transform:translateY(-20px) rotate(0deg); }
@keyframes confettiFall{ 0%{ transform:translate(var(--x,0),-30px) rotate(0deg); opacity:0; } 10%{ opacity:1; } 100%{ transform:translate(var(--x,0),520px) rotate(var(--rot,360deg)); opacity:0; } }

/* ===== Perudo cup ===== */
.cup {
  --cup: #ff5252;
  position: relative;
  width: 24px;
  height: 26px;
  flex: 0 0 24px;
  transform: rotate(180deg);
  clip-path: polygon(18% 10%, 82% 10%, 70% 96%, 30% 96%);
  background: var(--cup);
  border:1px solid rgba(0,0,0,0.35);
  box-shadow: inset 0 -2px 6px rgba(0,0,0,.35), 0 1px 2px rgba(0,0,0,.3);
}
.cup::after{
  content:''; position:absolute; left:14%; right:14%; bottom:-2px; height:3px; border-radius:3px;
  background: rgba(255,255,255,0.28);
}
@keyframes cupShake {
  0%   { transform: rotate(180deg) translateX(0) rotate(0deg); }
  10%  { transform: rotate(180deg) translateX(-1px) rotate(-2deg); }
  20%  { transform: rotate(180deg) translateX(1px) rotate(2deg); }
  30%  { transform: rotate(180deg) translateX(-1px) rotate(-2deg); }
  40%  { transform: rotate(180deg) translateX(1px) rotate(2deg); }
  50%  { transform: rotate(180deg) translateX(-1px) rotate(-2deg); }
  60%  { transform: rotate(180deg) translateX(1px) rotate(2deg); }
  70%  { transform: rotate(180deg) translateX(-1px) rotate(-1deg); }
  80%  { transform: rotate(180deg) translateX(1px) rotate(1deg); }
  90%  { transform: rotate(180deg) translateX(0) rotate(0deg); }
  100% { transform: rotate(180deg) translateX(0) rotate(0deg); }
}
.cup.shake { animation: cupShake 2s ease-in-out; }

/* ---- Lobby ---- */
.room-code{ font-weight:800; letter-spacing:1px; }
.color-picker{ display:grid; grid-template-columns:repeat(9,1fr); gap:8px; margin-top:8px; }
.swatch{ border:2px solid rgba(255,255,255,0.12); border-radius:10px; height:34px; cursor:pointer; position:relative; }
.swatch[data-color="#ffffff"]{ box-shadow: inset 0 0 0 1px rgba(0,0,0,0.35); }
.swatch.selected{ outline:3px solid #22c55e; }
.swatch .tick{ position:absolute; right:6px; top:6px; font-size:14px; display:none; }
.swatch.selected .tick{ display:block; }

.table-wrap{ display:grid; place-items:center; margin:12px 0 8px; }
.table{ width:100%; max-width:720px; aspect-ratio:1/1; border-radius:9999px; background:radial-gradient(75% 75% at 50% 30%, var(--table2), var(--table)); box-shadow:inset 0 8px 40px rgba(0,0,0,.45), 0 10px 30px rgba(0,0,0,.35); border:2px solid #0b3b8e; padding:18px; position:relative; overflow:visible; }
.seats{ position:absolute; inset:0; z-index:5; } .seat{ position:absolute; transform:translate(-50%,-50%); }
.seat-inner{ display:flex; align-items:center; gap:8px; background:rgba(0,0,0,0.28); padding:6px 8px; border-radius:12px; border:1px solid rgba(255,255,255,0.08); backdrop-filter:blur(2px); white-space:nowrap; }

/* ---- Menu dropdown ---- */
.dropdown{ position:absolute; right:0; top:44px; background:#0b1220; border:1px solid #1f2937; border-radius:12px; padding:8px; box-shadow:0 10px 24px rgba(0,0,0,.45); width:200px; z-index:1500; }
.dropdown button{ width:100%; padding:10px 12px; border-radius:10px; margin:4px 0; }
.menu-brand{ display:flex; flex-direction:column; align-items:center; justify-content:center; margin-bottom:8px; }
.menu-brand .brand{ font-size:34px; }
.menu-brand .slogan{ font-size:13px; }
.top-brand{ display:flex; flex-direction:column; align-items:flex-start; }
</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="title top-brand">
      <div class="brand" aria-label="CUPADOO!">
        <span class="r">C</span><span class="y">U</span><span class="o">P</span><span class="r">A</span><span class="y">D</span><span class="o">O</span><span class="r">O</span><span class="y">!</span>
      </div>
      <div class="slogan">Shake it. Fake it. Take it.</div>
    </div>
    <button id="btnMenu" class="menu-btn">Menu ‚ñæ</button>
    <div id="menuDropdown" class="dropdown hidden">
      <button id="ddHome" class="link">üè† Lobby</button>
      <button id="ddCopyCode" class="link">üîó Copy room code</button>
    </div>
  </div>

  <!-- Lobby -->
  <div class="card" id="screen-lobby">
    <div class="menu-brand center">
      <div class="brand"><span class="r">C</span><span class="y">U</span><span class="o">P</span><span class="r">A</span><span class="y">D</span><span class="o">O</span><span class="r">O</span><span class="y">!</span></div>
      <div class="slogan">Multiplayer ‚Äî Firebase RTDB</div>
      <div id="versionLabel" style="margin-top:6px;text-align:center;font-weight:800;color:#e5e7eb;opacity:0.9;">Version: v18</div>
    </div>

    <div class="row">
      <div><label>Your name</label><input id="youName" type="text" placeholder="You" value="You" /></div>
      <div><label>Room code</label><input id="roomCode" type="text" placeholder="e.g. Z3Q9K" /></div>
    </div>

    <h2 style="margin-top:12px;">Cup colour</h2>
    <p class="muted" style="margin-top:-6px;">Pick your cup colour. Try to choose unique colours.</p>
    <div id="colorPicker" class="color-picker"></div>

    <div class="row" style="margin-top:12px;">
      <button id="btnHost">Create room</button>
      <button id="btnJoin" class="secondary">Join room</button>
    </div>

    <div id="lobbyInfo" class="hidden" style="margin-top:8px;">
      <p>Room: <span class="room-code" id="displayRoom">‚Äî</span> ‚Ä¢ Players (2‚Äì6):</p>
      <div class="players" id="lobbyPlayers"></div>
      <div class="row" style="margin-top:10px;">
        <button id="btnStart" class="warn" disabled>Start game (host)</button>
        <button id="btnLeave" class="danger">Leave room</button>
      </div>
    </div>
  </div>

  <!-- Game -->
  <div class="card hidden" id="screen-game">
    <div class="row">
      <div class="pill" id="roundPill">Round 1</div>
      <div class="pill" id="turnPill">Your turn</div>
      <div class="pill" id="statusPill">&nbsp;</div>
      <div class="pill" id="totalPill">Total: 0 dice</div>
      <div class="pill hidden" id="palificoPill">Palifico active</div>
      <div class="pill" id="roomPill">Room: ‚Äî</div>
    </div>

    <h2 class="center" style="margin:6px 0 4px;">Your Dice</h2>
    <div class="dice" id="yourDice"></div>

    <div class="table-wrap">
      <div class="table" id="tableBoard">
        <div id="seats" class="seats"></div>
        <div id="bidCenter" class="bid-center">
          <div class="big" id="bidText">No bid yet</div>
          <div class="muted" id="bidBy"></div>
        </div>
      </div>
    </div>

    <h2>Players</h2>
    <div class="players" id="playersList"></div>

    <div id="controls" class="footer">
      <div class="row">
        <div><label>Quantity</label><input id="qty" type="number" min="1" value="1" /></div>
        <div><label id="faceLabel">Face (2‚Äì6)</label><input id="face" type="number" min="2" max="6" value="2" /></div>
      </div>
      <div class="row" style="margin-top:8px;">
        <button id="btnBid">Make Bid</button>
        <button id="btnDudo" class="danger">Dudo</button>
        <button id="btnCalza" class="warn">Calza (Exact)</button>
      </div>
    </div>
  </div>

  <div id="toaster" class="toast hidden"></div>

  <!-- Game Over overlay -->
  <div id="overlay" class="overlay hidden">
    <div class="modal">
      <div class="confetti-host" id="confettiHost"></div>
      <h3 id="overlayTitle">Game over</h3>
      <p id="overlayText">‚Äî</p>
      <div class="row" style="margin-top:12px;">
        <button id="btnRematch">Rematch</button>
        <button id="btnMenuFromOverlay" class="secondary">Lobby</button>
      </div>
    </div>
  </div>

  <!-- Reveal overlay -->
  <div id="revealOverlay" class="overlay hidden">
    <div id="revealModal" class="modal">
      <h3 id="revealTitle">üîç Reveal</h3>
      <p class="muted" id="revealSubtitle">Showing all dice‚Ä¶</p>
      <div id="revealGrid" class="reveal-grid"></div>
      <div class="count-line" id="countLine">Matches: 0</div>
      <div class="row" style="margin-top:10px;">
        <button id="btnRevealOk">Continue</button>
      </div>
    </div>
  </div>
</div>

<!-- Firebase compat CDN -->
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-database-compat.js"></script>

<script>
(()=>{
// ===== Utils + UI helpers =====
const $=s=>document.querySelector(s),el=(t,c,x)=>{const e=document.createElement(t); if(c)e.className=c; if(x!=null)e.textContent=x; return e;},rnd=n=>1+Math.floor(Math.random()*n),roll=n=>Array.from({length:n},()=>rnd(6)),sleep=ms=>new Promise(r=>setTimeout(r,ms));
function toast(m,ms=1600){const t=$('#toaster'); t.textContent=m; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'), ms);}
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
const DEFAULT_COLORS=['#ff0000','#ff7f00','#ffe100','#7c3aed','#16a34a','#2563eb','#ec4899','#111111','#ffffff'];
const CFG_KEY='perudoCfg_mp_v1';
function loadCfg(){try{return JSON.parse(localStorage.getItem(CFG_KEY)||'{}');}catch{return{};}}
function saveCfg(cfg){localStorage.setItem(CFG_KEY, JSON.stringify(cfg));}
function randomCode(len=5){ const chars='ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; let s=''; for(let i=0;i<len;i++) s+=chars[Math.floor(Math.random()*chars.length)]; return s; }
function cupEl(color){ const c=el('div','cup'); c.style.setProperty('--cup', color); return c; }
function dieSmall(face,cls=''){const d=el('div','die small '+cls,String(face)); return d;}
function dieReveal(face,is){const d=el('div','die reveal'+(is?' match':''),String(face)); return d;}
function onesWildForFace(face,g){ return !g.palifico && face!==1; }

// ===== Firebase setup =====
const firebaseConfig = {
  apiKey: "AIzaSyA1iB1gMq2UubLhlUDvDdnQPOZ1l5utGW8",
  authDomain: "cupadoo-80273.firebaseapp.com",
  projectId: "cupadoo-80273",
  storageBucket: "cupadoo-80273.firebasestorage.app",
  messagingSenderId: "827895807709",
  appId: "1:827895807709:web:806035be2f119d3993e534",
  measurementId: "G-8MHF4LZ9JR",
  databaseURL: "https://cupadoo-80273-default-rtdb.europe-west1.firebasedatabase.app/"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ===== Identity & room refs =====
const uid = (localStorage.getItem('uid') || (()=>{ const id='u'+Math.random().toString(36).slice(2,9); localStorage.setItem('uid',id); return id; })());
let roomCode=null, isHost=false;
let roomRef=null, playersRef=null, stateRef=null, inputsRef=null;

// ===== Game state (mirrors the RTDB /state) =====
const state={ players:[], youId:uid, turnIndex:0, round:1, hands:{}, bid:null, palifico:false, palificoFace:null, roundStarterIndex:0, gameOver:false, message:'' };

// ===== Rendering =====
function renderSeats(){
  const box=$('#seats'); if(!box) return;
  const table=$('#tableBoard'); const rect=table.getBoundingClientRect(); if(rect.width===0||rect.height===0){ return; }
  box.innerHTML='';
  const w=rect.width,h=rect.height,cx=w/2,cy=h/2,r=Math.min(w,h)/2-28;
  const seated=state.players.filter(p=>p.dice>0); const n=seated.length||1;
  seated.forEach((p,idx)=>{
    const ang=(-Math.PI/2)+(idx/n)*(Math.PI*2);
    const x=cx+r*Math.cos(ang), y=cy+r*Math.sin(ang);
    const seat=el('div','seat'+(state.players.indexOf(p)===state.turnIndex?' turn':'')); seat.style.left=x+'px'; seat.style.top=y+'px';
    const inner=el('div','seat-inner');
    inner.appendChild(cupEl(p.cup));
    const name=el('div','name', p.name+(p.id===uid?' (You)':'')); inner.appendChild(name);
    const lc=p.lastChoice;
    if(lc&&lc.type==='bid'){ inner.appendChild(el('span','last-text',`${lc.qty} √ó ${lc.face}'s`)); inner.appendChild(dieSmall(lc.face)); }
    else if(lc&&lc.type==='dudo'){ inner.appendChild(el('div','dudo-badge','DUDO')); }
    else if(lc&&lc.type==='calza'){ inner.appendChild(el('div','dudo-badge','CALZA')); }
    else inner.appendChild(el('span','last-text','‚Äî'));
    seat.appendChild(inner); box.appendChild(seat);
  });
}
function renderSeatsDeferred(){ requestAnimationFrame(renderSeats); }
function renderPlayersList(){
  const box=$('#playersList'); box.innerHTML='';
  state.players.forEach((p,idx)=>{
    const row=el('div','player'+(p.id===uid?' you':'')+(idx===state.turnIndex?' turn':''));
    const left=el('div','player-left'); left.appendChild(cupEl(p.cup));
    const nb=el('div'); nb.appendChild(el('div','', p.name+(p.id===uid?' (You)':'')));
    nb.appendChild(el('div','muted', p.dice>0 ? (p.dice+' dice') : '0 dice'));
    left.appendChild(nb);
    const right=el('div','player-right'); const lc=p.lastChoice;
    if(lc&&lc.type==='bid'){ right.appendChild(el('span','tag',`${lc.qty} √ó ${lc.face}'s`)); right.appendChild(dieSmall(lc.face)); }
    else if(lc&&lc.type==='dudo'){ right.appendChild(el('div','dudo-badge','DUDO')); }
    else if(lc&&lc.type==='calza'){ right.appendChild(el('div','dudo-badge','CALZA')); }
    else right.appendChild(el('span','tag','‚Äî'));
    if(p.dice<=0){ right.appendChild(el('span','skull','üíÄ')); }
    right.appendChild(el('span','pill', p.id===uid?'You':'P'+(idx+1)));
    row.append(left,right); box.appendChild(row);
  });
}
function renderYourDice(){ const box=$('#yourDice'); box.innerHTML=''; (state.hands[uid]||[]).forEach(v=> box.appendChild(el('div','die', String(v)))); }
function renderBid(){
  if(!state.bid){ $('#bidText').textContent='No bid yet'; $('#bidBy').textContent=''; return; }
  $('#bidText').textContent=`${state.bid.qty} √ó ${state.bid.face}'s${state.palifico?' ‚Ä¢ PALIFICO':''}${state.bid.face===1?' ‚Ä¢ ACES':''}`;
  const by=state.players.find(p=>p.id===state.bid.by);
  $('#bidBy').textContent=`by ${by?by.name:'Unknown'}`;
  setFirstBidControls();
}
function renderStatus(){
  $('#roundPill').textContent=`Round ${state.round}`;
  const turn=state.players[state.turnIndex];
  $('#turnPill').textContent= turn? `${turn.name}'s turn` : '‚Äî';
  $('#totalPill').textContent=`Total: ${totalDiceAlive(state)} dice`;
  $('#roomPill').textContent= roomCode ? `Room: ${roomCode}` : 'Room: ‚Äî';
  $('#statusPill').textContent= state.message || '';
}
function renderControls(){
  const myTurn = state.players[state.turnIndex]?.id===uid;
  const show = myTurn && !state.reveal && !state.gameOver;
  $('#controls').classList.toggle('hidden', !show);
  const calzaBtn=$('#btnCalza'); if(calzaBtn){ calzaBtn.disabled = state.palifico; calzaBtn.classList.toggle('hidden', state.palifico); }
  setFirstBidControls();
}
function render(){ renderSeatsDeferred(); renderPlayersList(); renderYourDice(); renderBid(); renderStatus(); renderControls(); }

// ===== Game helpers adapted to shared state =====
function alivePlayers(g=state){ return g.players.filter(p=>p.dice>0); }
function totalDiceAlive(g=state){ return g.players.reduce((s,p)=>s+(p.dice>0?p.dice:0),0); }
function nextAliveFrom(idx,g=state){ const n=g.players.length; for(let st=1;st<=n;st++){const i=(idx+st)%n; if(g.players[i].dice>0) return i;} return idx; }
function isValidRaise(qty,face,g=state){
  const numAlive = alivePlayers(g).length;
  if(!g.bid){
    if(g.palifico){
      if(numAlive>2){
        if(g.palificoFace==null) return false;
        return face===g.palificoFace && qty>=1;
      }else{
        return qty>=1 && face>=1 && face<=6;
      }
    }else{
      if(face===1) return false;
      return qty>=1 && face>=2 && face<=6;
    }
  }
  const b=g.bid;
  if(g.palifico){
    const locked=g.palificoFace ?? b.face;
    if(g.palificoFace==null) g.palificoFace=b.face;
    if(face!==locked) return false;
    return qty>b.qty;
  } else {
    if(b.face===face){ return qty>b.qty; }
    else if(face===1 && b.face!==1){ return qty>=Math.ceil(b.qty/2); }
    else if(b.face===1 && face!==1){ return qty>=(b.qty*2+1); }
    else { return (qty>b.qty) || (qty===b.qty && face>b.face); }
  }
}
function setFirstBidControls(){
  const faceInput=$('#face'), faceLabel=$('#faceLabel'); const numAlive=alivePlayers().length;
  if(!state.bid){
    if(state.palifico){
      if(numAlive>2 && state.palificoFace!=null){
        faceInput.min=faceInput.max=state.palificoFace; faceInput.value=state.palificoFace; faceInput.disabled=true; faceLabel.textContent=`Face (locked: ${state.palificoFace})`;
      }else{ faceInput.min=1; faceInput.max=6; faceInput.disabled=false; faceLabel.textContent='Face (1‚Äì6)'; }
    }else{ faceInput.min=2; faceInput.max=6; faceInput.disabled=false; if(parseInt(faceInput.value,10)<2) faceInput.value=2; faceLabel.textContent='Face (2‚Äì6)'; }
  }else{
    if(state.palifico && state.palificoFace!=null){
      faceInput.min=faceInput.max=state.palificoFace; faceInput.value=state.palificoFace; faceInput.disabled=true; faceLabel.textContent=`Face (locked: ${state.palificoFace})`;
    }else{ faceInput.min=1; faceInput.max=6; faceInput.disabled=false; faceLabel.textContent='Face (1‚Äì6)'; }
  }
}

// ===== Host-authoritative game logic =====
function startRoundHost(startTurnIndex=null){
  // v17: round-safe init (do NOT touch roster)
  // Reset only per-round fields
  state.bid = null;
  state.message = null;
  state.palifico = false;
  state.palificoFace = null;
  state.reveal = null;

  state.bid=null;
  if(startTurnIndex!=null) state.turnIndex=startTurnIndex;
  // Guard: ensure the new round starts on a live player
  if(!state.players[state.turnIndex] || state.players[state.turnIndex].dice<=0){
    state.turnIndex = nextAliveFrom(typeof state.turnIndex==='number' ? state.turnIndex : 0);
  }

  state.roundStarterIndex=state.turnIndex;
  state.palifico=(state.players[state.roundStarterIndex]?.dice===1);
  state.palificoFace=null;
  // roll hands
  state.hands={};
  for(const p of state.players) state.hands[p.id]=p.dice>0?roll(p.dice):[];
  if(state.palifico){
    const numAlive=alivePlayers().length;
    if(numAlive>2){
      const starter=state.players[state.roundStarterIndex];
      const dieVal=(state.hands[starter.id]||[])[0]||1;
      state.palificoFace=dieVal;
      state.message=`Palifico: everyone bids ${dieVal} ‚Ä¢ 1s not wild ‚Ä¢ no Calza`;
    } else {
      state.message=`Palifico (heads-up): first bid chooses face ‚Ä¢ 1s not wild ‚Ä¢ no Calza`;
    }
  }else{
    state.message='';
  }
  state.reveal=null;
  syncState();
}
function makeBidHost(byId, qty, face){
  if(!isValidRaise(qty,face)){ toast('Invalid bid'); return; }
  if(state.palifico && state.palificoFace==null) state.palificoFace=face;
  state.bid={qty,face,by:byId};
  state.message='';
  setLastChoice(byId,{type:'bid', qty, face});
  const curIndex=state.players.findIndex(p=>p.id===byId);
  state.turnIndex=nextAliveFrom(curIndex);
  syncState();
}
function setLastChoice(forId,choice){
  state.players=state.players.map(p=> (p.id===forId? {...p, lastChoice: choice } : p));
}
function countMatches(face,g=state){
  const ow=onesWildForFace(face,g);
  let t=0;
  for(const hand of Object.values(g.hands)) for(const d of hand) if(d===face || (ow&&d===1)) t++;
  return t;
}
async function handleDudoHost(callerId){
  if(!state.bid) return;
  state.reveal={ type:'dudo', face:state.bid.face, total: countMatches(state.bid.face), title:'üîç Dudo Reveal' };
  syncState(); // everyone shows overlay
}
async function handleCalzaHost(callerId){
  if(state.palifico || !state.bid) return;
  state.reveal={ type:'calza', face:state.bid.face, total: countMatches(state.bid.face), title:'üéØ Calza (Exact)' };
  syncState();
}
function finishRevealAndResolveHost(callerId){
  const type=state.reveal?.type; if(!type) return;
  const total=state.reveal.total;
  if(type==='dudo'){
    const bidder=state.players.find(p=>p.id===state.bid.by);
    const caller=state.players.find(p=>p.id===callerId);
    let loser=caller, reason='';
    if(total>=state.bid.qty){ loser=caller; reason=`Dudo failed: ${total} ‚â• ${state.bid.qty}.`; }
    else { loser=bidder; reason=`Dudo success: ${total} < ${state.bid.qty}.`; }
    endOfRoundHost(loser, reason);
  } else if(type==='calza'){
    const caller=state.players.find(p=>p.id===callerId);
    if(total===state.bid.qty){
      caller.dice=Math.min(8, caller.dice+1);
      const idx=state.players.indexOf(caller);
      state.round+=1; state.reveal=null; state.message=`Calza correct! Exactly ${total}. ${caller.name} gains a die.`;
      startRoundHost(idx);
    } else {
      state.message=`Calza wrong: ${total} (needed exactly ${state.bid.qty}). ${caller.name} loses a die.`;
      endOfRoundHost(caller, state.message);
    }
  }
}
function endOfRoundHost(loser, reason){
  // v17: snapshot roster before any changes
  try{ window.__lastPlayersSnapshot = JSON.parse(JSON.stringify(state.players||[])); }catch(e){}

  if(loser) loser.dice=Math.max(0, loser.dice-1);
  state.reveal=null;
  const alive=alivePlayers();
  if(alive.length<=1){
    const winner=alive[0]||null;
    const msg=`${winner?.name||'Nobody'} wins!`;
    state.gameOver=true; state.message=msg; syncState();
    return;
  }
  const loserIdx=state.players.indexOf(loser);
  const startIdx=loser.dice>0 ? loserIdx : nextAliveFrom(loserIdx);
  state.round+=1; state.message=reason;
  startRoundHost(startIdx);
}

// ===== RTDB sync =====
function syncAll(){
  // v17: full write when dice actually change
  if(!Array.isArray(state.players)||!state.players.length){
    if(Array.isArray(window.__lastPlayersSnapshot)&&window.__lastPlayersSnapshot.length){
      state.players = JSON.parse(JSON.stringify(window.__lastPlayersSnapshot));
    }
  } else {
    try{ window.__lastPlayersSnapshot = JSON.parse(JSON.stringify(state.players)); }catch(e){}
  }
  if(stateRef) stateRef.set(state);
}
function syncPartial(patch){
  // v17: small safe updates (never touch players array)
  const patchSafe = Object.assign({}, patch||{});
  if('players' in patchSafe) delete patchSafe.players;
  if(stateRef) stateRef.update(patchSafe);
}
function processInput(a){
  // Validate whose turn
  const curId=state.players[state.turnIndex]?.id;
  if(a.by!==curId && !(a.type==='continueReveal' && isHost)) return; // ignore out-of-turn (or allow host to continue)
  if(a.type==='bid'){ makeBidHost(a.by, a.qty, a.face); }
  if(a.type==='dudo'){ setLastChoice(a.by,{type:'dudo'}); handleDudoHost(a.by); syncState(); }
  if(a.type==='calza'){ setLastChoice(a.by,{type:'calza'}); handleCalzaHost(a.by); syncState(); }
  if(a.type==='continueReveal'){ finishRevealAndResolveHost(a.by); syncState(); }
}

// ===== Presence & lobby =====
const lobby = { players: new Map() };
function renderLobbyPlayers(list){
  const box=$('#lobbyPlayers'); box.innerHTML='';
  list.forEach(p=>{
    const row=el('div','player'+(p.id===uid?' you':''));
    const left=el('div','player-left'); left.appendChild(cupEl(p.cup||'#ff0000'));
    const nb=el('div'); nb.appendChild(el('div','', p.name+(p.id===uid?' (You)':'')));
    nb.appendChild(el('div','muted', p.connected?'online':'offline'));
    left.appendChild(nb);
    const right=el('div','player-right'); right.appendChild(el('span','pill', p.id===state.hostId?'Host':'Player'));
    row.append(left,right); box.appendChild(row);
  });
}
function enterLobbyUI(code){
  $('#lobbyInfo').classList.remove('hidden');
  $('#displayRoom').textContent=code;
  $('#btnStart').disabled=true;
}
function leaveLobbyUI(){
  $('#lobbyInfo').classList.add('hidden');
  $('#displayRoom').textContent='‚Äî';
}
function goToLobby(){ $('#screen-lobby').classList.remove('hidden'); $('#screen-game').classList.add('hidden'); }
function goToGame(){ $('#screen-lobby').classList.add('hidden'); $('#screen-game').classList.remove('hidden'); renderSeatsDeferred(); }

function attachRoomListeners(){
  playersRef.on('value', snap=>{
    const vals=snap.val()||{};
    const arr=Object.values(vals).map(v=>({...v})).sort((a,b)=> (a.joinTs||0)-(b.joinTs||0));
    renderLobbyPlayers(arr);
    // Enable start for host (2-6 players)
    const count = arr.filter(p=>p.connected!==false).length;
    $('#btnStart').disabled = !(isHost && count>=1 && count<=6);
  });
  // Host consumes inputs
  inputsRef.on('child_added', s=>{
    if(!isHost) return;
    const a=s.val(); processInput(a);
    s.ref.remove();
  });
  // State updates -> render game
  stateRef.on('value', snap=>{
    const g=snap.val();
    if(!g) return;
    // copy into local state
    Object.assign(state, g);
    if(g.status==='playing' || g.players?.length){
      goToGame();
      render();
      if(g.reveal){ showRevealOverlay(g.reveal); } else { hideRevealOverlay(); }
      if(g.gameOver){ showGameOver(g.message||'Game over'); }
    }
  });
}
function detachRoomListeners(){
  if(playersRef){ playersRef.off(); }
  if(inputsRef){ inputsRef.off(); }
  if(stateRef){ stateRef.off(); }
}

async function createRoom(){
  const code=randomCode();
  roomCode=code; isHost=true;
  roomRef=db.ref('rooms/'+code);
  playersRef=roomRef.child('players');
  inputsRef=roomRef.child('inputs');
  stateRef=roomRef.child('state');
  await roomRef.set({ createdAt: firebase.database.ServerValue.TIMESTAMP, status:'lobby', hostId:uid });
  await joinSelf();
  enterLobbyUI(code);
  attachRoomListeners();
  toast('Room created');
}
async function joinRoom(code){
  code=(code||'').toUpperCase().trim();
  if(!code){ toast('Enter a room code'); return; }
  roomCode=code; isHost=false;
  roomRef=db.ref('rooms/'+code);
  const snap=await roomRef.get();
  if(!snap.exists()){ toast('Room not found'); return; }
  playersRef=roomRef.child('players'); inputsRef=roomRef.child('inputs'); stateRef=roomRef.child('state');
  enterLobbyUI(code);
  await joinSelf();
  attachRoomListeners();
  toast('Joined room');
}
async function joinSelf(){
  const cfg=loadCfg();
  const name = ($('#youName').value||cfg.youName||'You').slice(0,24);
  const cup = cfg.youCup || DEFAULT_COLORS[0];
  saveCfg({ ...cfg, youName:name, youCup: cup });
  const myRef = playersRef.child(uid);
  await myRef.set({ id:uid, name, cup, connected:true, joinTs: firebase.database.ServerValue.TIMESTAMP });
  myRef.onDisconnect().remove();
}
async function leaveRoom(){
  try{ await playersRef.child(uid).remove(); }catch{}
  detachRoomListeners();
  roomRef=null; playersRef=null; stateRef=null; inputsRef=null;
  roomCode=null; isHost=false; leaveLobbyUI(); goToLobby();
  toast('Left room');
}

// ===== Start game (host) =====
async function hostStart(){
  if(!isHost) return;
  const snap=await playersRef.get();
  const vals=snap.val()||{};
  let arr=Object.values(vals).map(v=>({id:v.id, name:v.name, cup:v.cup, dice:5}));
  // Auto-fill AI to reach minimum of 2 players (max 6 total)
  if(arr.length < 2){
    const need = Math.min(2 - arr.length, 6 - arr.length);
    for(let i=0;i<need;i++){
      arr.push({ id: 'AI'+i, name: 'AI'+i, cup: DEFAULT_COLORS[(i+3)%DEFAULT_COLORS.length], dice: 5 });
    }
  }
  if(arr.length<2){ toast('Need at least 2 players'); return; }
  // random order
  arr=shuffle(arr);
  state.players=arr; state.round=1; state.gameOver=false; state.message=''; state.status='playing';
  state.hostId=uid;
  // roll and choose random starter
  const aliveIdx = state.players.map((p,i)=> p.dice>0 ? i : -1).filter(i=>i>=0);
  const startIdx = aliveIdx[Math.floor(Math.random()*aliveIdx.length)] ?? 0;
  startRoundHost(startIdx);
  syncState();
  toast('Game started');
}

// ===== Reveal overlay behaviour =====
function buildRevealGrid(face){
  const ow=onesWildForFace(face,state);
  const grid=$('#revealGrid'); grid.innerHTML='';
  for(const p of state.players){
    const row=el('div','reveal-row'); row.appendChild(cupEl(p.cup));
    row.appendChild(el('div','reveal-name', p.name+(p.id===uid?' (You)':'')));
    const strip=el('div','reveal-dice');
    (state.hands[p.id]||[]).forEach(v=>{ const is=(v===face || (ow && v===1)); strip.appendChild(dieReveal(v,is)); });
    row.appendChild(strip); grid.appendChild(row);
  }
}
async function showRevealOverlay(rev){
  if(!rev) return;
  $('#revealTitle').textContent=rev.title || 'üîç Reveal';
  const ow=onesWildForFace(rev.face,state);
  $('#revealSubtitle').textContent=`Counting dice for face ${rev.face}${ow? ' (1s are wild)‚Ä¶' : ' (1s do not count)‚Ä¶'}`;
  buildRevealGrid(rev.face); $('#revealOverlay').classList.remove('hidden');
  const total=rev.total||0;
  const line=$('#countLine'); line.textContent='Matches: 0'; let cur=0;
  while(cur<total){ await sleep(120); cur++; line.textContent=`Matches: ${cur}`; }
  // Host continues; others wait
  const btn=$('#btnRevealOk');
  btn.disabled=!isHost;
  btn.textContent = isHost ? 'Continue' : 'Waiting for host‚Ä¶';
}
function hideRevealOverlay(){ $('#revealOverlay').classList.add('hidden'); }

// ===== Game over overlay =====
function showGameOver(text){ $('#overlayTitle').textContent='Game over'; $('#overlayText').textContent=text||'‚Äî'; $('#overlay').classList.remove('hidden'); }
function hideOverlay(){ $('#overlay').classList.add('hidden'); }

// ===== UI events =====
document.getElementById('btnHost').addEventListener('click', ()=> createRoom());
document.getElementById('btnJoin').addEventListener('click', ()=> joinRoom($('#roomCode').value));
document.getElementById('btnLeave').addEventListener('click', ()=> leaveRoom());
document.getElementById('btnStart').addEventListener('click', ()=> hostStart());
document.getElementById('btnRematch').addEventListener('click', ()=>{ hideOverlay(); if(isHost){ hostStart(); }});
document.getElementById('btnMenuFromOverlay').addEventListener('click', ()=>{ hideOverlay(); goToLobby(); });

document.getElementById('btnBid').addEventListener('click', ()=>{
  const q=parseInt($('#qty').value,10)||1; const f=Math.max(1,Math.min(6,parseInt($('#face').value,10)||1));
  if(isHost){ makeBidHost(uid,q,f); } else { inputsRef.push({type:'bid', qty:q, face:f, by:uid, ts: firebase.database.ServerValue.TIMESTAMP}); }
});
document.getElementById('btnDudo').addEventListener('click', ()=>{
  if(isHost){ setLastChoice(uid,{type:'dudo'}); handleDudoHost(uid); syncState(); } else { inputsRef.push({type:'dudo', by:uid, ts: firebase.database.ServerValue.TIMESTAMP}); }
});
document.getElementById('btnCalza').addEventListener('click', ()=>{
  if(isHost){ setLastChoice(uid,{type:'calza'}); handleCalzaHost(uid); syncState(); } else { inputsRef.push({type:'calza', by:uid, ts: firebase.database.ServerValue.TIMESTAMP}); }
});
document.getElementById('btnRevealOk').addEventListener('click', ()=>{
  if(isHost){ inputsRef.push({type:'continueReveal', by:uid, ts: firebase.database.ServerValue.TIMESTAMP}); }
});

// Keep seats responsive
const table = document.getElementById('tableBoard');
if('ResizeObserver' in window){ new ResizeObserver(()=> renderSeatsDeferred()).observe(table); } else { window.addEventListener('resize', renderSeatsDeferred); }

// Menu dropdown
const btnMenu = document.getElementById('btnMenu');
const dd = document.getElementById('menuDropdown');
function closeDD(){ dd.classList.add('hidden'); }
btnMenu.addEventListener('click', (e)=>{ e.stopPropagation(); dd.classList.toggle('hidden'); });
document.addEventListener('click', ()=> closeDD());
document.getElementById('ddHome').addEventListener('click', ()=>{ closeDD(); goToLobby(); });
document.getElementById('ddCopyCode').addEventListener('click', async ()=>{
  closeDD(); if(!roomCode){ toast('No room yet'); return; }
  try{ await navigator.clipboard.writeText(roomCode); toast('Room code copied'); }catch{ toast('Room: '+roomCode); }
});

// Color picker (persist choice)
function renderColorPicker(){
  const cfg=loadCfg();
  const box = document.getElementById('colorPicker'); box.innerHTML='';
  const chosen = cfg.youCup || DEFAULT_COLORS[0];
  DEFAULT_COLORS.forEach(col=>{
    const sw = document.createElement('div');
    sw.className='swatch'; sw.dataset.color=col; sw.style.background=col;
    if(col.toLowerCase()===chosen.toLowerCase()) sw.classList.add('selected');
    const tick=document.createElement('div'); tick.className='tick'; tick.textContent='‚úì'; sw.appendChild(tick);
    sw.addEventListener('click', ()=>{
      document.querySelectorAll('.swatch').forEach(s=>s.classList.remove('selected'));
      sw.classList.add('selected');
      const cfg=loadCfg(); saveCfg({...cfg, youCup: col});
      toast('Cup colour saved');
    });
    box.appendChild(sw);
  });
}
renderColorPicker();
// Restore saved name
const cfg=loadCfg(); if(cfg.youName) $('#youName').value = cfg.youName;

// Toast helper for first-time hint
toast('Create or join a room to begin');

})();</script>

<script>
// Live, copyable debug panel (no changes to existing code/menus)
(function(){
  function ensurePanel(){
    if(document.getElementById('liveDebug')) return;
    const pre=document.createElement('pre');
    pre.id='liveDebug';
    Object.assign(pre.style,{
      position:'fixed',left:'50%',transform:'translateX(-50%)',bottom:'10px',
      width:'92vw',maxWidth:'820px',maxHeight:'38vh',overflow:'auto',
      margin:'0',padding:'8px 10px',borderRadius:'10px',
      background:'rgba(0,0,0,0.85)',color:'#3bf83b',
      font:'12px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace',
      whiteSpace:'pre-wrap',zIndex:99999,userSelect:'text',display:'none'
    });
    pre.textContent='[CUPADOO DEBUG]\nTap and hold to copy...';
    document.body.appendChild(pre);
  }
  function snapshot(){
    const s = window.state || {};
    const cur = (s.players && typeof s.turnIndex==='number') ? s.players[s.turnIndex] : null;
    return JSON.stringify({
      round: s.round, turnIndex: s.turnIndex,
      current: cur? {id:cur.id,name:cur.name,dice:cur.dice}:null,
      bid: s.bid||null, message: s.message||'',
      palifico: !!s.palifico, palificoFace: s.palificoFace??null,
      players: Array.isArray(s.players)? s.players.map(p=>({id:p.id,name:p.name,dice:p.dice,lastChoice:p.lastChoice||null})) : []
    }, null, 2);
  }
  function tick(){
    const pre=document.getElementById('liveDebug');
    const g=document.getElementById('screen-game');
    if(!pre||!g) return;
    const inGame=!g.classList.contains('hidden');
    pre.style.display=inGame?'block':'none';
    if(!inGame) return;
    pre.textContent='[CUPADOO DEBUG]\n'+snapshot();
  }
  window.addEventListener('load', function(){ ensurePanel(); setInterval(tick, 400); });
})();
</script>


<!-- v17 guards: ignore bad snapshots & reseed turn -->
<script>
(function(){
  let lastGood=null;
  function clone(o){ try{return JSON.parse(JSON.stringify(o));}catch(e){return null;} }
  function valid(s){
    return s && Array.isArray(s.players) && s.players.length && typeof s.turnIndex==='number' && s.players[s.turnIndex];
  }
  function firstAlive(s){ for(let i=0;i<(s.players||[]).length;i++){ if(s.players[i]&&s.players[i].dice>0) return i; } return 0; }
  function nextAliveFrom(i,s){ const n=s.players.length; for(let k=1;k<=n;k++){ const j=(i+k)%n; if(s.players[j]&&s.players[j].dice>0) return j; } return (i+1)%n; }
  function reseed(){
    const s=window.state||{};
    if(!Array.isArray(s.players)||!s.players.length){
      const snap = (window.__lastPlayersSnapshot && window.__lastPlayersSnapshot.length && window.__lastPlayersSnapshot) || null;
      if(snap){ s.players = clone(snap); }
    }
    if(Array.isArray(s.players)&&s.players.length){
      if(typeof s.turnIndex!=='number' || !s.players[s.turnIndex] || s.players[s.turnIndex].dice<=0){
        if(s.bid){
          const i=s.players.findIndex(p=>p.id===s.bid.by);
          if(i>=0) s.turnIndex=nextAliveFrom(i,s);
        }
        if(typeof s.turnIndex!=='number' || !s.players[s.turnIndex]) s.turnIndex=firstAlive(s);
      }
    }
    if(typeof window.render==='function'){ try{ window.render(); }catch(e){} }
    if(typeof window.renderControls==='function'){ try{ window.renderControls(); }catch(e){} }
  }
  // Save last good state
  setInterval(function(){
    if(valid(window.state)){ lastGood=clone(window.state); window.__lastPlayersSnapshot = clone(window.state.players); }
  }, 400);
  // After any remote update, validate & heal
  const attach=setInterval(function(){
    if(window.stateRef && stateRef.on){ try{ stateRef.on('value', function(){ setTimeout(function(){ if(!valid(window.state) && lastGood){ window.state=clone(lastGood); reseed(); } },0); }); clearInterval(attach);}catch(e){} }
  }, 400);
})();
</script>

</body>
</html>
