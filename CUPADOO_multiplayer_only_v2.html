<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1" />
<title>CUPADOO! â€” Multiplayer (v2)</title>
<style>
:root { --bg:#0f172a; --panel:#0b1220; --card:#111827; --text:#e5e7eb; --muted:#94a3b8; --accent:#22c55e; --danger:#ef4444; --warn:#f59e0b; --table:#1e3a8a; --table2:#2563eb; }
*{ box-sizing:border-box; } body{ margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; }
.wrap{ max-width:980px; margin:0 auto; padding:16px; } .topbar{ position:relative; display:flex; align-items:flex-start; justify-content:space-between; gap:10px; margin-bottom:10px; }
.title{ display:flex; flex-direction:column; line-height:1; }
.brand{ font-weight:900; font-size:22px; letter-spacing:0.5px; font-family: 'Fredoka','Nunito','Poppins','system-ui',-apple-system,Segoe UI,Roboto,Helvetica,Arial; }
.slogan{ margin-top:4px; font-size:12px; color:var(--muted); font-weight:700; font-style:italic; }
.menu-btn{ padding:10px 12px; border-radius:12px; background:#0b1220; border:1px solid #1f2937; color:var(--text); font-weight:700; align-self:flex-start; }
.card{ background:var(--card); border-radius:18px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.35); }
.row{ display:flex; gap:10px; } .row>*{ flex:1; }
button{ width:100%; padding:14px; border:none; border-radius:14px; font-weight:700; font-size:16px; background:linear-gradient(180deg,#22c55e,#16a34a); color:#05170c; cursor:pointer; }
button.secondary{ background:#1f2937; color:var(--text); }
button.warn{ background:linear-gradient(180deg,var(--warn),#eab308); color:#111; }
button.danger{ background:linear-gradient(180deg,var(--danger),#b91c1c); color:#fff; }
button[disabled]{ opacity:.45; cursor:not-allowed; }
input[type=text]{ width:100%; padding:12px; border-radius:12px; border:1px solid #1f2937; background:var(--panel); color:var(--text); font-size:16px; }
.pill{ display:inline-block; padding:6px 10px; border-radius:999px; background:var(--panel); color:var(--muted); font-size:12px; }
.players{ display:grid; gap:10px; } .player{ display:flex; align-items:center; justify-content:space-between; background:#101523; border:1px solid #1f2937; padding:10px 12px; border-radius:14px; }
.player.you{ outline:2px solid var(--accent); } .turn{ border:1px dashed var(--accent); }
.muted{ color:var(--muted); }
.dice{ display:flex; gap:8px; flex-wrap:wrap; justify-content:center; }
.die{ width:44px; height:44px; border-radius:12px; background:var(--panel); display:grid; place-items:center; font-weight:800; font-size:20px; border:1px solid #1f2937; }
.hidden{ display:none !important; } .center{ text-align:center; } .big{ font-size:28px; font-weight:800; letter-spacing:1px; }
.table-wrap{ display:grid; place-items:center; margin:12px 0 8px; }
.table{ width:100%; max-width:720px; aspect-ratio:1/1; border-radius:9999px; background:radial-gradient(75% 75% at 50% 30%, var(--table2), var(--table)); box-shadow:inset 0 8px 40px rgba(0,0,0,.45), 0 10px 30px rgba(0,0,0,.35); border:2px solid #0b3b8e; padding:18px; position:relative; overflow:visible; }
#bidText{ text-shadow:0 2px 8px rgba(0,0,0,.35); }
textarea.log{ width:100%; height:200px; background:#020617; color:#e2e8f0; border:1px solid #1f2937; border-radius:8px; padding:8px; resize:vertical; }
.dropdown{ position:absolute; right:0; top:44px; width:320px; }
.kv{display:grid;grid-template-columns:180px 1fr;gap:8px;font-family:ui-monospace,monospace}.kv div{padding:4px 0;border-bottom:1px dashed #263044}
</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="title">
      <div class="brand">CUPADOO! <span class="pill">Multiplayer</span></div>
      <div class="slogan">Perudo â€” up to 6 players</div>
    </div>
    <button id="btnMenu" class="menu-btn">Debug â–¾</button>
    <div id="menuDropdown" class="dropdown hidden card">
      <div class="kv">
        <div>dbURL</div><div id="kv-db">â€”</div>
        <div>isHost</div><div id="kv-host">â€”</div>
        <div>playerId</div><div id="kv-pid">â€”</div>
        <div>playerName</div><div id="kv-pname">â€”</div>
        <div>roomCode</div><div id="kv-room">â€”</div>
        <div>players path</div><div id="kv-ppath">â€”</div>
        <div>lastError</div><div id="kv-err" style="color:#ef4444">â€”</div>
      </div>
      <textarea id="debugLog" class="log" spellcheck="false" readonly></textarea>
    </div>
  </div>

  <!-- Lobby -->
  <div class="card" id="screen-lobby">
    <h2>Lobby</h2>
    <div class="row">
      <button id="btnCreate">Create Room</button>
      <button id="btnTest" class="secondary">Test Write</button>
    </div>
    <div class="row">
      <input id="joinCode" placeholder="Enter code (e.g., F8ZQ)" maxlength="8" />
      <button id="btnJoin">Join</button>
    </div>
    <div class="row hidden" id="roomRow">
      <div class="pill">Room: <span id="roomCodeLbl">â€”</span></div>
      <button id="btnCopy" class="secondary">Copy Code</button>
      <button id="btnLeave" class="warn">Leave</button>
    </div>
    <h3>Players</h3>
    <div id="playersList" class="players"></div>
    <button id="btnStart" disabled>Start Game</button>
    <p class="muted">Host can start when at least 2 humans are present. AIs will fill empty seats to 6.</p>
  </div>

  <!-- Game -->
  <div class="card hidden" id="screen-game">
    <div class="row">
      <div class="pill" id="roundPill">Round 1</div>
      <div class="pill" id="turnPill">â€”</div>
      <div class="pill" id="totalPill">Total: 0</div>
      <div class="pill hidden" id="palificoPill">Palifico</div>
    </div>
    <h2 class="center" style="margin:6px 0 4px;">Your Dice</h2>
    <div class="dice" id="yourDice"></div>
    <div class="table-wrap">
      <div class="table">
        <div class="big center" id="bidText">No bid yet</div>
        <div class="center muted" id="bidBy"></div>
      </div>
    </div>
    <h2>Players</h2>
    <div class="players" id="playersPanel"></div>
    <div id="controls">
      <div class="row">
        <div><label>Qty</label><input id="qty" type="text" value="1" /></div>
        <div><label id="faceLabel">Face (2â€“6)</label><input id="face" type="text" value="2" /></div>
      </div>
      <div class="row" style="margin-top:8px;">
        <button id="btnBid">Bid</button>
        <button id="btnDudo" class="danger">Dudo</button>
        <button id="btnCalza" class="warn">Calza</button>
      </div>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script>
(()=>{
const $=s=>document.querySelector(s);
const dbgEl = document.getElementById('debugLog'); function dbg(...a){ const line=a.map(v=>{try{return typeof v==='object'?JSON.stringify(v):String(v);}catch{return String(v);}}).join(' '); if(dbgEl){dbgEl.value+=`[${new Date().toISOString()}] ${line}\n`; dbgEl.scrollTop=dbgEl.scrollHeight;} console.log(...a); }
function setKV(id,v){ const el=document.getElementById(id); if(el) el.textContent=v; }
const rnd=n=>1+Math.floor(Math.random()*n); const roll=n=>Array.from({length:n},()=>rnd(6));
function generateCode(){ const c="ABCDEFGHJKLMNPQRSTUVWXYZ23456789"; return Array.from({length:4},()=>c[Math.floor(Math.random()*c.length)]).join(''); }

// Firebase
const cfg={apiKey:"AIzaSyA1iB1gMq2UubLhlUDvDdnQPOZ1l5utGW8",authDomain:"cupadoo-80273.firebaseapp.com",databaseURL:"https://cupadoo-80273-default-rtdb.europe-west1.firebasedatabase.app",projectId:"cupadoo-80273",storageBucket:"cupadoo-80273.firebasestorage.app",messagingSenderId:"827895807709",appId:"1:827895807709:web:806035be2f119d3993e534",measurementId:"G-8MHF4LZ9JR"};
const app=firebase.apps?.length?firebase.app():firebase.initializeApp(cfg); const db=firebase.database(); setKV('kv-db', app.options?.databaseURL||'(none)');

let playerId="p"+Math.floor(Math.random()*999999);
let playerName="Player "+Math.floor(Math.random()*1000);
let isHost=false; setKV('kv-host', isHost); setKV('kv-pid', playerId); setKV('kv-pname', playerName);

let roomCode=null, playerRef=null, playersRef=null, stateRef=null, heartbeat=null, hostLoop=null, lastActStamp=0;

function renderLobby(players){
  const box=document.getElementById('playersList'); box.innerHTML='';
  Object.entries(players||{}).forEach(([id,p])=>{
    const row=document.createElement('div'); row.className='player'+(id===playerId?' you':'');
    row.innerHTML=`<div>${(p&&p.name)||'(anon)'}${p&&p.host?' â€” Host':''}</div><div class="pill">${id}</div>`;
    box.appendChild(row);
  });
  const humans=Object.values(players||{}).filter(p=>p&&!p.ai).length;
  document.getElementById('btnStart').disabled=!(isHost && humans>=2);
}

async function selfHeal(players){
  const me = (players||{})[playerId]||{};
  const fix={};
  if(!('name' in me)) fix.name=playerName;
  if(!('host' in me)) fix.host=isHost;
  if(!('ai' in me)) fix.ai=false;
  if(Object.keys(fix).length){ dbg('ðŸ©¹ Self-heal (lobby):', fix); try{ await playerRef.update(fix);}catch(e){ setKV('kv-err', e.message);} }
}

async function joinRoom(code){
  roomCode=code; setKV('kv-room', code); document.getElementById('roomCodeLbl').textContent=code;
  document.getElementById('roomRow').classList.remove('hidden');

  playerRef=db.ref(`rooms/${code}/players/${playerId}`);
  await playerRef.set({ name:playerName, host:isHost, ai:false, dice:5, lastSeen: firebase.database.ServerValue.TIMESTAMP });
  await playerRef.onDisconnect().remove();
  if(heartbeat) clearInterval(heartbeat);
  heartbeat=setInterval(()=> playerRef.child('lastSeen').set(firebase.database.ServerValue.TIMESTAMP), 10000);

  playersRef=db.ref(`rooms/${code}/players`);
  playersRef.on('value', s=>{ const val=s.val()||{}; renderLobby(val); selfHeal(val); });

  stateRef=db.ref(`rooms/${code}/state`);
  stateRef.on('value', s=>{
    const st=s.val();
    if(!st || !st.started){ return; }
    document.getElementById('screen-lobby').classList.add('hidden');
    document.getElementById('screen-game').classList.remove('hidden');
    renderGame(st);
  });

  // Host loop to drive AIs reliably (poll + guard on updatedAt)
  if(hostLoop) clearInterval(hostLoop);
  hostLoop=setInterval(async ()=>{
    if(!isHost) return;
    const snap=await stateRef.once('value'); const st=snap.val();
    if(!st || !st.started || st.inReveal || st.gameOver) return;
    if(st.updatedAt && st.updatedAt===lastActStamp) return; // avoid double
    const curId=st.order[st.turnIndex]; if(!curId || !curId.startsWith('AI')) return;
    // decide & act
    lastActStamp = st.updatedAt;
    await actForAI(st, curId);
  }, 800);
}

document.getElementById('btnCreate').onclick=async()=>{ isHost=true; setKV('kv-host', isHost); await joinRoom(generateCode()); };
document.getElementById('btnJoin').onclick=async()=>{ const c=(document.getElementById('joinCode').value||'').trim().toUpperCase(); if(!c)return; isHost=false; setKV('kv-host', isHost); await joinRoom(c); };
document.getElementById('btnCopy').onclick=async()=>{ try{await navigator.clipboard.writeText(roomCode);}catch{} };
document.getElementById('btnLeave').onclick=async()=>{
  try{ if(heartbeat) clearInterval(heartbeat); if(playersRef) playersRef.off(); if(stateRef) stateRef.off(); if(playerRef) await playerRef.remove(); if(hostLoop) clearInterval(hostLoop); }
  finally{ roomCode=null; isHost=false; setKV('kv-host', isHost); setKV('kv-room','â€”'); document.getElementById('roomRow').classList.add('hidden'); document.getElementById('screen-game').classList.add('hidden'); document.getElementById('screen-lobby').classList.remove('hidden'); }
};
document.getElementById('btnTest').onclick=()=>{ const r=db.ref('__debug/ping').push(); r.set({t:Date.now(),ua:navigator.userAgent}).then(()=>dbg('âœ… test write ok')).catch(e=>setKV('kv-err',e.message)); };

document.getElementById('btnStart').onclick=async()=>{
  if(!isHost) return;
  const pSnap=await playersRef.once('value'); const players=pSnap.val()||{};
  const humans=Object.values(players).filter(p=>p&&!p.ai).length; if(humans<2) return;

  // Fill AIs to 6
  const names=['Ava','Blake','Casey','Drew','Eden','Flynn','Gray','Harper','Indi','Joss','Kai','Lex'];
  const updates={}; let idx=0;
  while(Object.keys(players).length + Object.keys(updates).length < 6){
    const id='AI'+idx++; if(players[id]||updates[id]) continue; updates[id]={ name:names[(idx-1)%names.length], ai:true, host:false, dice:5 };
  }
  if(Object.keys(updates).length) await db.ref(`rooms/${roomCode}/players`).update(updates);

  const allSnap=await playersRef.once('value'); const all=allSnap.val()||{};
  const order=Object.keys(all); const hands={}; order.forEach(id=>{ const d=all[id].dice||5; hands[id]=roll(d); });
  const startIndex=Math.floor(Math.random()*order.length);
  await stateRef.set({ started:true, order, turnIndex:startIndex, round:1, bid:null, palifico:false, palificoFace:null, inReveal:false, gameOver:false, hands, lastChoice:{}, roundStarterIndex:startIndex, updatedAt:Date.now() });
};

/* ===== GAME ===== */
const onesWild=(st,face)=> !st.palifico && face!==1;
const totalDice=st=> st.order.reduce((s,id)=> s + ((st.hands[id]||[]).length), 0);
const nextAlive=(st,from)=>{ let i=from; for(let c=0;c<st.order.length;c++){ i=(i+1)%st.order.length; if((st.hands[st.order[i]]||[]).length>0) return i; } return from; };
function renderGame(st){
  document.getElementById('roundPill').textContent='Round '+st.round;
  document.getElementById('turnPill').textContent = (st.order[st.turnIndex]===playerId?'Your':'Their')+' turn';
  document.getElementById('totalPill').textContent='Total: '+totalDice(st);
  document.getElementById('palificoPill').classList.toggle('hidden', !st.palifico);
  const yd=document.getElementById('yourDice'); yd.innerHTML=''; (st.hands[playerId]||[]).forEach(v=>{ const d=document.createElement('div'); d.className='die'; d.textContent=String(v); yd.appendChild(d); });
  const panel=document.getElementById('playersPanel'); panel.innerHTML=''; st.order.forEach((id,idx)=>{ const row=document.createElement('div'); row.className='player'+(id===playerId?' you':'')+(idx===st.turnIndex?' turn':''); row.innerHTML=`<div>${id===playerId?'You':id}</div><div class="muted">${(st.hands[id]||[]).length} dice</div>`; panel.appendChild(row); });
  const b=st.bid; if(!b){ document.getElementById('bidText').textContent='No bid yet'; document.getElementById('bidBy').textContent=''; } else { document.getElementById('bidText').textContent=`${b.qty} Ã— ${b.face}'s ${st.palifico?'â€¢ PALIFICO':''}`; document.getElementById('bidBy').textContent=`by ${b.by===playerId?'You':b.by}`; }
  const myTurn = st.order[st.turnIndex]===playerId && !st.inReveal && !st.gameOver;
  document.getElementById('controls').classList.toggle('hidden', !myTurn);
}

function isValidRaise(st, qty, face){
  if(!st.bid){
    if(st.palifico){
      return (st.palificoFace!=null ? face===st.palificoFace : face>=1&&face<=6) && qty>=1;
    } else { return face>=2 && face<=6 && qty>=1; }
  }
  const b=st.bid;
  if(st.palifico){
    const locked=st.palificoFace ?? b.face;
    if(face!==locked) return false;
    return qty>b.qty;
  } else {
    if(b.face===face) return qty>b.qty;
    if(face===1 && b.face!==1) return qty>=Math.ceil(b.qty/2);
    if(b.face===1 && face!==1) return qty>=(b.qty*2+1);
    return (qty>b.qty) || (qty===b.qty && face>b.face);
  }
}
async function writeState(p){ p.updatedAt=Date.now(); await stateRef.update(p); }
function countMatches(st, face){ const wild=onesWild(st,face); let t=0; for(const arr of Object.values(st.hands)) for(const d of (arr||[])) if(d===face || (wild && d===1)) t++; return t; }

async function revealAndAdvance(st, loserId){
  const hands={...st.hands}; if((hands[loserId]||[]).length>0) hands[loserId]=hands[loserId].slice(0, hands[loserId].length-1);
  const alive=Object.keys(hands).filter(id => (hands[id]||[]).length>0);
  if(alive.length<=1){ await writeState({ gameOver:true, hands, inReveal:false }); return; }
  const loserIndex=st.order.indexOf(loserId);
  const nextStarter = (hands[loserId]||[]).length>0 ? loserIndex : nextAlive({...st,hands}, loserIndex);
  const newHands={}; for(const id of st.order){ const n=(hands[id]||[]).length; newHands[id]= n>0 ? roll(n) : []; }
  const palifico = (newHands[st.order[nextStarter]]||[]).length===1;
  await writeState({ hands:newHands, bid:null, inReveal:false, round:st.round+1, roundStarterIndex:nextStarter, turnIndex:nextStarter, palifico, palificoFace:null, lastChoice:{} });
}

document.getElementById('btnBid').onclick=async()=>{
  const s=(await stateRef.once('value')).val(); if(!s) return;
  if(s.order[s.turnIndex]!==playerId || s.inReveal || s.gameOver) return;
  const qty=parseInt(document.getElementById('qty').value,10)||1;
  const face=Math.max(1,Math.min(6,parseInt(document.getElementById('face').value,10)||2));
  if(!isValidRaise(s, qty, face)) return;
  const palFace = (!s.bid && s.palifico && s.palificoFace==null) ? face : s.palificoFace;
  await writeState({ bid:{qty,face,by:playerId}, lastChoice:{...s.lastChoice,[playerId]:{type:'bid',qty,face}}, turnIndex: nextAlive(s, s.turnIndex), palificoFace:palFace });
};

document.getElementById('btnDudo').onclick=async()=>{
  const s=(await stateRef.once('value')).val(); if(!s) return;
  if(s.order[s.turnIndex]!==playerId || s.inReveal || s.gameOver || !s.bid) return;
  await writeState({ inReveal:true, lastChoice:{...s.lastChoice,[playerId]:{type:'dudo'}} });
  const total=countMatches(s, s.bid.face);
  const loser = (total>=s.bid.qty) ? playerId : s.bid.by;
  await revealAndAdvance(s, loser);
};

document.getElementById('btnCalza').onclick=async()=>{
  const s=(await stateRef.once('value')).val(); if(!s || s.palifico || !s.bid) return;
  if(s.order[s.turnIndex]!==playerId || s.inReveal || s.gameOver) return;
  await writeState({ inReveal:true, lastChoice:{...s.lastChoice,[playerId]:{type:'calza'}} });
  const total=countMatches(s, s.bid.face);
  if(total===s.bid.qty){
    const hands={...s.hands}; const n=(hands[playerId]||[]).length; hands[playerId]=roll(Math.min(8,n+1));
    const startIndex=s.order.indexOf(playerId);
    await writeState({ hands, inReveal:false, bid:null, round:s.round+1, roundStarterIndex:startIndex, turnIndex:startIndex, palifico:(hands[playerId].length===1), palificoFace:null, lastChoice:{} });
  } else {
    await revealAndAdvance(s, playerId);
  }
};

/* ===== AI driver (host) ===== */
function probTail(st, face, qty, hand){
  const N=totalDice(st)-hand.length;
  const p=onesWild(st,face)?(2/6):(1/6);
  let mine=0; for(const d of hand) if(d===face || (onesWild(st,face)&&d===1)) mine++;
  const need=Math.max(0, qty-mine);
  let s=0; function fact(n){let r=1; for(let i=2;i<=n;i++) r*=i; return r;}
  function choose(n,k){ return fact(n)/(fact(k)*fact(n-k)); }
  for(let k=need;k<=N;k++){ s+=choose(N,k)*Math.pow(p,k)*Math.pow(1-p,N-k); }
  return s;
}
function aiDecision(st, id){
  const hand=st.hands[id]||[];
  if(!st.bid){
    let best={face:2, qty:1, score:-1};
    for(let f=2; f<=6; f++){ const score=probTail(st,f,1,hand); if(score>best.score) best={face:f,qty:1,score}; }
    return {type:'bid', qty:best.qty, face:best.face};
  }
  const b=st.bid;
  const t=probTail(st, b.face, b.qty, hand);
  if(t<0.18) return {type:'dudo'};
  // raise minimally valid
  for(let q=b.qty; q<=b.qty*2+3; q++){
    for(let f=1; f<=6; f++){
      if(isValidRaise(st,q+(f===b.face?0:0)+1, f)){ return {type:'bid', qty:q+(f===b.face?0:0)+1, face:f}; }
    }
  }
  return {type:'dudo'};
}
async function actForAI(st, id){
  const action=aiDecision(st,id);
  if(action.type==='dudo'){
    await writeState({ inReveal:true, lastChoice:{...st.lastChoice,[id]:{type:'dudo'}} });
    const total=countMatches(st, st.bid.face);
    const loser = (total>=st.bid.qty) ? id : st.bid.by;
    await revealAndAdvance(st, loser);
  } else if(action.type==='bid'){
    const palFace = (!st.bid && st.palifico && st.palificoFace==null) ? action.face : st.palificoFace;
    await writeState({ bid:{qty:action.qty, face:action.face, by:id}, lastChoice:{...st.lastChoice,[id]:{type:'bid',qty:action.qty,face:action.face}}, turnIndex: nextAlive(st, st.turnIndex), palificoFace:palFace });
  }
}

})();</script>
</body>
</html>
